<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css">
    <title>피로도 테스트 · 운동 측정</title>
    <style>
      :root {
        --bg: #020617;
        --accent: #7c3aed;
        --text-main: #e5e7eb;
        --text-muted: #b8c5d6;
        --ok: #4ade80;
        --danger: #f97373;
        --wait: #fbbf24;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-main);
        background: #020617;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      header {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
      }
      .back-btn {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(2, 6, 23, 0.9);
        color: var(--text-main);
        text-decoration: none;
        font-size: 12px;
      }
      .back-btn:hover { border-color: rgba(148, 163, 184, 0.9); }
      .test-container {
        width: 100%;
        max-width: 700px;
        margin-top: 60px;
      }
      .instruction {
        text-align: center;
        font-size: 16px;
        font-weight: 650;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-weight: 600;
        margin-bottom: 20px;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-main);
        white-space: pre-line;
      }
      .timer-display {
        text-align: center;
        font-size: 64px;
        font-weight: 700;
        color: var(--ok);
        margin-bottom: 20px;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .key-button {
        width: 100%;
        height: 200px;
        border-radius: 20px;
        border: 4px solid rgba(148, 163, 184, 0.6);
        background: #1a1a1a;
        color: var(--text-main);
        font-size: 32px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.1s;
        user-select: none;
      }
      .key-button:active {
        background: var(--ok);
        border-color: var(--ok);
        transform: scale(0.98);
      }
      .key-button.active {
        background: var(--ok);
        border-color: var(--ok);
      }
      .key-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background: rgba(51, 65, 85, 0.5);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 20px;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--ok), var(--wait));
        transition: width 0.1s linear;
      }
      .sections-panel {
        margin-top: 30px;
        padding: 20px;
        background: rgba(2, 6, 23, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(51, 65, 85, 0.9);
        display: none;
      }
      .section-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        font-size: 14px;
      }
      .section-item:last-child {
        border-bottom: none;
      }
      .section-label {
        font-weight: 600;
      }
      .section-value {
        color: var(--ok);
        font-weight: 600;
      }
      .results-panel {
        margin-top: 30px;
        padding: 20px;
        background: rgba(2, 6, 23, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(51, 65, 85, 0.9);
        width: 100%;
        display: none;
      }
      .result-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        font-size: 14px;
      }
      .result-item:last-child {
        border-bottom: none;
        font-weight: 600;
        color: var(--ok);
        margin-top: 8px;
        padding-top: 12px;
        border-top: 2px solid rgba(51, 65, 85, 0.9);
      }
      .btn-primary {
        margin-top: 20px;
        padding: 10px 20px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(120deg, #4f46e5, #7c3aed, #22c55e);
        color: white;
        font-weight: 550;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
      }
      .btn-primary:hover { filter: brightness(1.1); }
      .btn-primary:disabled { opacity: 0.5; cursor: default; }
      .retry-btn {
        margin-top: 10px;
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(2, 6, 23, 0.8);
        color: var(--text-main);
        font-weight: 500;
        cursor: pointer;
        font-size: 13px;
        width: 100%;
      }
      .retry-btn:hover {
        background: rgba(2, 6, 23, 0.95);
        border-color: rgba(148, 163, 184, 0.9);
      }
      .warning-text {
        text-align: center;
        font-size: 14px;
        color: var(--wait);
        margin-top: 10px;
        font-weight: 500;
      }
      .stop-btn {
        margin-top: 15px;
        padding: 10px 20px;
        border-radius: 999px;
        border: 2px solid var(--danger);
        background: rgba(249, 115, 115, 0.1);
        color: var(--danger);
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
      }
      .stop-btn:hover {
        background: rgba(249, 115, 115, 0.2);
      }
      .chart-container {
        margin-top: 20px;
        padding: 20px;
        background: rgba(2, 6, 23, 0.9);
        border-radius: 12px;
        border: 1px solid rgba(51, 65, 85, 0.9);
      }
      #fatigue-chart {
        width: 100%;
        height: 300px;
      }
    </style>
  </head>
  <body>
    <header>
      <a href="motor_hub.html" class="back-btn">← 허브로</a>
      <div style="font-size: 12px; color: var(--text-muted);">피로도 테스트</div>
    </header>

    <div class="test-container">
      <div class="instruction" id="instruction">30초 동안 지속적으로 클릭하세요</div>
      <div class="warning-text" id="warning-text">⚠️ 무리하지 마세요. 언제든지 중단할 수 있습니다.</div>
      
      <div class="timer-display" id="timer-display">30</div>

      <button class="key-button" id="key-button" disabled>
        <div id="key-display">SPACE</div>
      </button>

      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
      </div>

      <button class="stop-btn" id="stop-btn" style="display: none;">중단하기</button>

      <div class="sections-panel" id="sections-panel">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">구간별 클릭 수 (5초 단위)</div>
        <div id="sections-content"></div>
      </div>

      <div class="results-panel" id="results-panel">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">측정 결과</div>
        <div id="results-content"></div>
        <div class="chart-container" id="chart-container" style="display: none;">
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center;">구간별 클릭 수 그래프</div>
          <canvas id="fatigue-chart"></canvas>
        </div>
        <button class="btn-primary" id="save-btn">결과 저장 & 허브로 이동</button>
        <button class="retry-btn" id="retry-btn">다시 측정하기</button>
      </div>
    </div>

    <script src="ga-storage.js"></script>
    <script>
      (function () {
        const instruction = document.getElementById("instruction");
        const timerDisplay = document.getElementById("timer-display");
        const keyButton = document.getElementById("key-button");
        const keyDisplay = document.getElementById("key-display");
        const progressFill = document.getElementById("progress-fill");
        const sectionsPanel = document.getElementById("sections-panel");
        const sectionsContent = document.getElementById("sections-content");
        const warningText = document.getElementById("warning-text");
        const stopBtn = document.getElementById("stop-btn");
        const resultsPanel = document.getElementById("results-panel");
        const resultsContent = document.getElementById("results-content");
        const chartContainer = document.getElementById("chart-container");
        const saveBtn = document.getElementById("save-btn");
        const retryBtn = document.getElementById("retry-btn");

        const TEST_DURATION = 30; // 30초
        const SECTION_DURATION = 5; // 5초 단위 (총 6구간)
        const TARGET_KEY = "SPACE";

        let testActive = false;
        let startTime = 0;
        let inputs = [];
        let sections = [];
        let timerInterval = null;
        let progressInterval = null;

        function startTest() {
          testActive = true;
          startTime = Date.now();
          inputs = [];
          sections = [];
          keyButton.disabled = false;
          keyButton.classList.add("active");
          instruction.textContent = "최대한 빠르게 " + TARGET_KEY + " 키를 연타하세요!";
          warningText.style.display = "block";
          stopBtn.style.display = "block";
          sectionsPanel.style.display = "block";
          
          let elapsed = 0;
          timerInterval = setInterval(function() {
            elapsed = (Date.now() - startTime) / 1000;
            const remaining = Math.max(0, TEST_DURATION - elapsed);
            timerDisplay.textContent = Math.ceil(remaining);
            progressFill.style.width = ((elapsed / TEST_DURATION) * 100) + "%";
            
            updateSections(elapsed);
            
            if (remaining <= 0) {
              endTest();
            }
          }, 100);
        }

        function stopTest() {
          if (!testActive) return;
          if (confirm("테스트를 중단하시겠습니까? 현재까지의 결과가 저장됩니다.")) {
            const elapsed = (Date.now() - startTime) / 1000;
            endTest(elapsed);
          }
        }

        function updateSections(elapsed) {
          for (let i = 0; i < 6; i++) {
            const sectionStartTime = i * SECTION_DURATION;
            const sectionEndTime = (i + 1) * SECTION_DURATION;
            const sectionInputs = inputs.filter(function(input) {
              return input.elapsed >= sectionStartTime && input.elapsed < sectionEndTime;
            });
            const sectionDuration = Math.max(0, Math.min(sectionEndTime, elapsed) - sectionStartTime);
            const rate = sectionDuration > 0 ? sectionInputs.length / sectionDuration : 0;
            
            if (!sections[i]) {
              sections[i] = {
                section: i + 1,
                startTime: sectionStartTime,
                endTime: sectionEndTime,
                inputs: sectionInputs,
                count: sectionInputs.length,
                rate: rate
              };
            } else {
              sections[i].inputs = sectionInputs;
              sections[i].count = sectionInputs.length;
              sections[i].rate = sectionDuration > 0 ? sectionInputs.length / sectionDuration : 0;
            }
          }
          renderSections();
        }

        function renderSections() {
          let html = "";
          sections.forEach(function(section) {
            html += '<div class="section-item">';
            html += '<span class="section-label">' + Math.floor(section.startTime) + '~' + Math.floor(section.endTime) + '초</span>';
            html += '<span class="section-value">' + section.count + ' 클릭 (' + Math.round(section.rate) + '/초)</span>';
            html += '</div>';
          });
          sectionsContent.innerHTML = html;
        }

        function handleInput() {
          if (!testActive) return;
          const elapsed = (Date.now() - startTime) / 1000;
          inputs.push({
            timestamp: Date.now(),
            elapsed: elapsed,
            inputNumber: inputs.length + 1
          });
          
          updateSections(elapsed);
        }

        function endTest(actualDuration) {
          testActive = false;
          keyButton.disabled = true;
          keyButton.classList.remove("active");
          stopBtn.style.display = "none";
          
          if (timerInterval) clearInterval(timerInterval);
          if (progressInterval) clearInterval(progressInterval);
          
          const totalTime = actualDuration || TEST_DURATION;
          const firstSection = sections[0];
          const lastSection = sections[5] || sections[sections.length - 1];

          let fatigueIndex = 0;
          if (firstSection && lastSection && firstSection.count > 0) {
            fatigueIndex = (lastSection.count / firstSection.count) * 100;
          }

          instruction.style.display = "none";
          warningText.style.display = "none";
          timerDisplay.style.display = "none";
          keyButton.style.display = "none";
          progressFill.parentElement.style.display = "none";
          sectionsPanel.style.display = "none";
          resultsPanel.style.display = "block";
          
          showResults(totalTime, fatigueIndex);
        }

        function drawChart() {
          if (sections.length === 0) return;
          
          const canvas = document.getElementById("fatigue-chart");
          const ctx = canvas.getContext("2d");
          const width = canvas.width = canvas.offsetWidth;
          const height = canvas.height = 300;
          
          ctx.clearRect(0, 0, width, height);
          
          const padding = { top: 20, right: 20, bottom: 40, left: 50 };
          const chartWidth = width - padding.left - padding.right;
          const chartHeight = height - padding.top - padding.bottom;
          
          const maxRate = Math.max.apply(null, sections.map(function(s) { return s.rate; })) * 1.1;
          const minRate = 0;
          
          ctx.strokeStyle = "rgba(148, 163, 184, 0.3)";
          ctx.lineWidth = 1;
          for (let i = 0; i <= 5; i++) {
            const y = padding.top + (chartHeight / 5) * i;
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(width - padding.right, y);
            ctx.stroke();
            
            ctx.fillStyle = "#9ca3af";
            ctx.font = "11px sans-serif";
            ctx.textAlign = "right";
            ctx.fillText(Math.round(maxRate - (maxRate / 5) * i), padding.left - 10, y + 4);
          }
          
          ctx.strokeStyle = "#00ffcc";
          ctx.lineWidth = 3;
          ctx.beginPath();
          
          sections.forEach(function(section, index) {
            const x = padding.left + (chartWidth / (sections.length - 1 || 1)) * index;
            const y = padding.top + chartHeight - (section.rate / maxRate) * chartHeight;
            
            if (index === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
            
            ctx.fillStyle = "#00ffcc";
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
          });
          
          ctx.stroke();
          
          ctx.fillStyle = "#e5e7eb";
          ctx.font = "12px sans-serif";
          ctx.textAlign = "center";
          sections.forEach(function(section, index) {
            const x = padding.left + (chartWidth / (sections.length - 1 || 1)) * index;
            ctx.fillText(section.section, x, height - padding.bottom + 20);
          });
          
          ctx.save();
          ctx.translate(15, height / 2);
          ctx.rotate(-Math.PI / 2);
          ctx.fillStyle = "#e5e7eb";
          ctx.font = "13px sans-serif";
          ctx.textAlign = "center";
          ctx.fillText("입력 속도 (입력/초)", 0, 0);
          ctx.restore();
        }

        function showResults(totalTime, fatigueIndex) {
          const firstSection = sections[0];
          const lastSection = sections[sections.length - 1];
          
          let html = '<div class="result-item"><span>총 입력 수</span><span>' + inputs.length + ' 회</span></div>';
          html += '<div class="result-item"><span>측정 시간</span><span>' + Math.round(totalTime) + ' 초</span></div>';
          if (firstSection) {
            html += '<div class="result-item"><span>첫 5초 클릭 수</span><span>' + firstSection.count + ' 회</span></div>';
          }
          if (lastSection) {
            html += '<div class="result-item"><span>마지막 5초 클릭 수</span><span>' + lastSection.count + ' 회</span></div>';
          }
          html += '<div class="result-item"><span>피로도 지수</span><span>' + fatigueIndex.toFixed(1) + '%</span></div>';
          html += '<div class="result-item" style="font-size: 12px; color: var(--text-muted);"><span>※ 마지막5초/첫5초×100. 낮을수록 피로도 높음</span></div>';
          html += '<div class="result-item" style="margin-top: 12px;"><strong>섹션별 상세 데이터:</strong></div>';
          sections.forEach(function(section) {
            html += '<div class="result-item" style="font-size: 12px;"><span>' + Math.floor(section.startTime) + '~' + Math.floor(section.endTime) + '초</span><span>' + section.count + ' 클릭, ' + Math.round(section.rate) + '/초</span></div>';
          });
          resultsContent.innerHTML = html;
          
          if (sections.length > 0) {
            chartContainer.style.display = "block";
            setTimeout(function() {
              drawChart();
            }, 100);
          }
        }

        function resetTest() {
          testActive = false;
          startTime = 0;
          inputs = [];
          sections = [];
          
          instruction.style.display = "block";
          instruction.textContent = "30초 동안 지속적으로 클릭하세요";
          warningText.style.display = "block";
          timerDisplay.style.display = "flex";
          timerDisplay.textContent = "30";
          keyButton.style.display = "block";
          keyButton.disabled = false;
          keyButton.classList.remove("active");
          stopBtn.style.display = "none";
          progressFill.style.width = "0%";
          progressFill.parentElement.style.display = "block";
          sectionsPanel.style.display = "none";
          chartContainer.style.display = "none";
          resultsPanel.style.display = "none";
          
          if (timerInterval) clearInterval(timerInterval);
          if (progressInterval) clearInterval(progressInterval);
        }

        keyButton.addEventListener("click", function() {
          if (!testActive && startTime === 0) {
            startTest();
          } else if (testActive) {
            handleInput();
          }
        });

        stopBtn.addEventListener("click", stopTest);

        document.addEventListener("keydown", function(e) {
          if (e.code === "Space") {
            e.preventDefault();
            if (!testActive && startTime === 0) {
              startTest();
            } else if (testActive) {
              handleInput();
            }
          }
          if (e.key === "Escape" && testActive) {
            e.preventDefault();
            stopTest();
          }
        });

        saveBtn.addEventListener("click", function () {
          const firstSection = sections[0];
          const lastSection = sections[5] || sections[sections.length - 1];
          const actualDuration = inputs.length > 0 ? Math.min(inputs[inputs.length - 1].elapsed, TEST_DURATION) : 0;

          const fatigue_log = sections.slice(0, 6).map(function(s) { return s ? s.count : 0; });
          let fatigueIndex = 0;
          if (firstSection && lastSection && firstSection.count > 0) {
            fatigueIndex = (lastSection.count / firstSection.count) * 100;
          }

          const session = (typeof GAStorage !== "undefined" && GAStorage.readSession()) || {};
          if (!session.user_data) session.user_data = {};
          const motor = session.user_data.motor_results || {};
          motor.fatigue = {
            totalInputs: inputs.length,
            duration: parseFloat(actualDuration.toFixed(2)),
            completed: actualDuration >= TEST_DURATION - 1,
            fatigue_log: fatigue_log,
            sections: sections.slice(0, 6).map(function(section) {
              if (!section) return { startTime: 0, endTime: 0, count: 0, rate: 0 };
              return {
                section: section.section,
                startTime: parseFloat(section.startTime.toFixed(2)),
                endTime: parseFloat(section.endTime.toFixed(2)),
                count: section.count,
                rate: parseFloat(section.rate.toFixed(2))
              };
            }),
            firstSectionCount: firstSection ? firstSection.count : 0,
            lastSectionCount: lastSection ? lastSection.count : 0,
            fatigueIndex: parseFloat(fatigueIndex.toFixed(2)),
            allInputs: inputs.map(function(input) {
              return {
                inputNumber: input.inputNumber,
                elapsed: parseFloat(input.elapsed.toFixed(3)),
                timestamp: input.timestamp
              };
            }),
            unit: "inputs/second",
            recordedAt: new Date().toISOString()
          };
          if (typeof GAStorage !== "undefined") {
            GAStorage.writeSession({ motor: motor });
          }
          window.location.href = "motor_hub.html";
        });

        retryBtn.addEventListener("click", resetTest);
      })();
    </script>
  </body>
</html>
