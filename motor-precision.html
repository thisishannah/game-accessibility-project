<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css">
    <title>정밀도 테스트 · 운동 측정</title>
    <style>
      :root {
        --bg: #020617;
        --accent: #7c3aed;
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --ok: #4ade80;
        --danger: #f97373;
        --wait: #fbbf24;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-main);
        background: #020617;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      header {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
      }
      .back-btn {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(2, 6, 23, 0.9);
        color: var(--text-main);
        text-decoration: none;
        font-size: 12px;
      }
      .back-btn:hover { border-color: rgba(148, 163, 184, 0.9); }
      .test-container {
        width: 100%;
        max-width: 600px;
        margin-top: 60px;
      }
      .instruction {
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 30px;
        color: var(--text-main);
      }
      #target-area {
        width: 100%;
        height: 500px;
        background: #1a1a1a;
        border-radius: 16px;
        position: relative;
        cursor: crosshair;
        overflow: hidden;
      }
      .target {
        position: absolute;
        width: 40px;
        height: 40px;
        border: 3px solid var(--ok);
        border-radius: 50%;
        background: rgba(74, 222, 128, 0.1);
        transform: translate(-50%, -50%);
        top: 50%;
        left: 50%;
      }
      .target-center {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--ok);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        top: 50%;
        left: 50%;
        z-index: 2;
      }
      .click-dot {
        position: absolute;
        width: 6px;
        height: 6px;
        background: var(--danger);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 3;
      }
      .info-panel {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(2, 6, 23, 0.9);
        padding: 10px 20px;
        border-radius: 999px;
        font-size: 18px;
        font-weight: 600;
        z-index: 5;
      }
      .results-panel {
        margin-top: 30px;
        padding: 20px;
        background: rgba(2, 6, 23, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(51, 65, 85, 0.9);
        width: 100%;
        display: none;
      }
      .result-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        font-size: 14px;
      }
      .result-item:last-child {
        border-bottom: none;
        font-weight: 600;
        color: var(--ok);
        margin-top: 8px;
        padding-top: 12px;
        border-top: 2px solid rgba(51, 65, 85, 0.9);
      }
      .btn-primary {
        margin-top: 20px;
        padding: 10px 20px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(120deg, #4f46e5, #7c3aed, #22c55e);
        color: white;
        font-weight: 550;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
      }
      .btn-primary:hover { filter: brightness(1.1); }
      .btn-secondary {
        margin-top: 10px;
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(2, 6, 23, 0.8);
        color: var(--text-main);
        font-weight: 500;
        cursor: pointer;
        font-size: 13px;
        width: 100%;
      }
      .btn-secondary:hover {
        background: rgba(2, 6, 23, 0.95);
        border-color: rgba(148, 163, 184, 0.9);
      }
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .popup-content {
        background: #1a1a1a;
        border-radius: 20px;
        border: 2px solid #00ffcc;
        padding: 30px;
        max-width: 90vw;
        max-height: 90vh;
        overflow: auto;
        position: relative;
      }
      .popup-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        line-height: 1;
      }
      .popup-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      #visualization-canvas {
        display: block;
        margin: 20px auto;
        border: 1px solid rgba(148, 163, 184, 0.5);
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <header>
      <a href="motor_hub.html" class="back-btn">← 허브로</a>
      <div style="font-size: 12px; color: var(--text-muted);">정밀도 테스트</div>
    </header>

    <div class="test-container">
      <div class="instruction" id="instruction">정중앙의 타겟을 정확하게 클릭하세요 (총 20회)</div>
      
      <div id="target-area">
        <div class="info-panel" id="info-panel">클릭: 0/20</div>
        <div class="target"></div>
        <div class="target-center"></div>
      </div>

      <div class="results-panel" id="results-panel">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">측정 결과</div>
        <div id="results-content"></div>
        <button class="btn-primary" id="save-btn">결과 저장 & 허브로 이동</button>
        <button class="btn-secondary" id="visualize-btn">편향 시각화 보기</button>
      </div>
    </div>

    <div class="popup-overlay" id="popup-overlay">
      <div class="popup-content">
        <button class="popup-close" onclick="closePopup()">×</button>
        <h2 style="color:#00ffcc; margin-top:0;">클릭 편향 시각화</h2>
        <p style="font-size:0.9em; color:#9ca3af; margin-bottom:15px;">
          빨간 점은 실제 클릭 지점, 청록색 원은 타겟 중심입니다. 점들의 분포를 통해 편향 방향을 확인할 수 있습니다.
        </p>
        <canvas id="visualization-canvas"></canvas>
      </div>
    </div>

    <script src="ga-storage.js"></script>
    <script>
      (function () {
        const targetArea = document.getElementById("target-area");
        const infoPanel = document.getElementById("info-panel");
        const instruction = document.getElementById("instruction");
        const resultsPanel = document.getElementById("results-panel");
        const resultsContent = document.getElementById("results-content");
        const saveBtn = document.getElementById("save-btn");
        const visualizeBtn = document.getElementById("visualize-btn");

        const TOTAL_CLICKS = 20;
        const TARGET_CENTER_X = targetArea.offsetWidth / 2;
        const TARGET_CENTER_Y = targetArea.offsetHeight / 2;
        const TARGET_RADIUS = 20;

        let clicks = [];
        let currentClick = 0;

        /**
         * 타겟 중심과 클릭 지점 사이의 거리 계산 (픽셀 오차)
         * 공식: distance = √[(x2 - x1)² + (y2 - y1)²]
         * @param {number} x1 - 타겟 중심 X 좌표
         * @param {number} y1 - 타겟 중심 Y 좌표
         * @param {number} x2 - 클릭 지점 X 좌표
         * @param {number} y2 - 클릭 지점 Y 좌표
         * @returns {number} 픽셀 단위 거리
         */
        function calculateDistance(x1, y1, x2, y2) {
          return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        targetArea.addEventListener("click", function (e) {
          if (currentClick >= TOTAL_CLICKS) return;
          
          const rect = targetArea.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const clickY = e.clientY - rect.top;
          
          const error = calculateDistance(clickX, clickY, TARGET_CENTER_X, TARGET_CENTER_Y);
          
          clicks.push({
            x: clickX,
            y: clickY,
            error: error,
            timestamp: Date.now()
          });
          
          const dot = document.createElement("div");
          dot.className = "click-dot";
          dot.style.left = clickX + "px";
          dot.style.top = clickY + "px";
          targetArea.appendChild(dot);
          
          currentClick++;
          infoPanel.textContent = "클릭: " + currentClick + "/" + TOTAL_CLICKS;
          
          if (currentClick >= TOTAL_CLICKS) {
            showResults();
          }
        });

        function showResults() {
          instruction.style.display = "none";
          targetArea.style.display = "none";
          resultsPanel.style.display = "block";
          
          const errors = clicks.map(function(c) { return c.error; });
          const averageError = errors.reduce(function(a, b) { return a + b; }, 0) / errors.length;
          const maxError = Math.max.apply(null, errors);
          const minError = Math.min.apply(null, errors);
          
          let html = '<div class="result-item"><span>평균 오차 거리</span><span>' + averageError.toFixed(2) + ' px</span></div>';
          html += '<div class="result-item"><span>최대 오차</span><span>' + maxError.toFixed(2) + ' px</span></div>';
          html += '<div class="result-item"><span>최소 오차</span><span>' + minError.toFixed(2) + ' px</span></div>';
          html += '<div class="result-item"><span>총 클릭 수</span><span>' + clicks.length + ' 회</span></div>';
          resultsContent.innerHTML = html;
        }

        function showVisualization() {
          const visCanvas = document.getElementById("visualization-canvas");
          const visCtx = visCanvas.getContext("2d");
          const size = Math.min(600, window.innerWidth - 100);
          visCanvas.width = size;
          visCanvas.height = size;
          
          visCtx.fillStyle = "#1a1a1a";
          visCtx.fillRect(0, 0, size, size);
          
          const centerX = size / 2;
          const centerY = size / 2;
          const scale = Math.min(size / targetArea.offsetWidth, size / targetArea.offsetHeight) * 0.8;
          
          visCtx.strokeStyle = "rgba(148, 163, 184, 0.3)";
          visCtx.lineWidth = 1;
          for (let i = 0; i <= 10; i++) {
            const pos = (size / 10) * i;
            visCtx.beginPath();
            visCtx.moveTo(pos, 0);
            visCtx.lineTo(pos, size);
            visCtx.stroke();
            visCtx.beginPath();
            visCtx.moveTo(0, pos);
            visCtx.lineTo(size, pos);
            visCtx.stroke();
          }
          
          visCtx.strokeStyle = "#00ffcc";
          visCtx.lineWidth = 2;
          visCtx.beginPath();
          visCtx.arc(centerX, centerY, TARGET_RADIUS * scale, 0, Math.PI * 2);
          visCtx.stroke();
          
          visCtx.fillStyle = "#00ffcc";
          visCtx.beginPath();
          visCtx.arc(centerX, centerY, 2, 0, Math.PI * 2);
          visCtx.fill();
          
          clicks.forEach(function(click) {
            const x = centerX + (click.x - TARGET_CENTER_X) * scale;
            const y = centerY + (click.y - TARGET_CENTER_Y) * scale;
            
            visCtx.fillStyle = "#f97373";
            visCtx.beginPath();
            visCtx.arc(x, y, 3, 0, Math.PI * 2);
            visCtx.fill();
          });
          
          const avgX = clicks.reduce(function(sum, c) { return sum + (c.x - TARGET_CENTER_X); }, 0) / clicks.length;
          const avgY = clicks.reduce(function(sum, c) { return sum + (c.y - TARGET_CENTER_Y); }, 0) / clicks.length;
          
          if (Math.abs(avgX) > 1 || Math.abs(avgY) > 1) {
            const biasX = centerX + avgX * scale;
            const biasY = centerY + avgY * scale;
            
            visCtx.strokeStyle = "#fbbf24";
            visCtx.lineWidth = 2;
            visCtx.setLineDash([5, 5]);
            visCtx.beginPath();
            visCtx.moveTo(centerX, centerY);
            visCtx.lineTo(biasX, biasY);
            visCtx.stroke();
            visCtx.setLineDash([]);
            
            visCtx.fillStyle = "#fbbf24";
            visCtx.beginPath();
            visCtx.arc(biasX, biasY, 4, 0, Math.PI * 2);
            visCtx.fill();
          }
          
          visCtx.fillStyle = "#fff";
          visCtx.font = "12px sans-serif";
          visCtx.textAlign = "left";
          visCtx.fillText("범례:", 20, size - 40);
          visCtx.fillStyle = "#00ffcc";
          visCtx.fillRect(20, size - 30, 12, 12);
          visCtx.fillStyle = "#fff";
          visCtx.fillText("타겟 중심", 38, size - 20);
          visCtx.fillStyle = "#f97373";
          visCtx.beginPath();
          visCtx.arc(20, size - 10, 3, 0, Math.PI * 2);
          visCtx.fill();
          visCtx.fillStyle = "#fff";
          visCtx.fillText("클릭 지점", 38, size - 6);
          if (Math.abs(avgX) > 1 || Math.abs(avgY) > 1) {
            visCtx.fillStyle = "#fbbf24";
            visCtx.beginPath();
            visCtx.arc(20, size + 10, 4, 0, Math.PI * 2);
            visCtx.fill();
            visCtx.fillStyle = "#fff";
            visCtx.fillText("평균 편향", 38, size + 16);
          }
          
          document.getElementById("popup-overlay").style.display = "flex";
        }

        function closePopup() {
          document.getElementById("popup-overlay").style.display = "none";
        }

        saveBtn.addEventListener("click", function () {
          if (clicks.length < TOTAL_CLICKS) return;
          
          const errors = clicks.map(function(c) { return c.error; });
          const averageError = errors.reduce(function(a, b) { return a + b; }, 0) / errors.length;
          
          const avgX = clicks.reduce(function(sum, c) { return sum + (c.x - TARGET_CENTER_X); }, 0) / clicks.length;
          const avgY = clicks.reduce(function(sum, c) { return sum + (c.y - TARGET_CENTER_Y); }, 0) / clicks.length;
          
          const session = (typeof GAStorage !== "undefined" && GAStorage.readSession()) || {};
          if (!session.user_data) session.user_data = {};
          const motor = session.user_data.motor_results || {};
          motor.precision = {
            averageError: parseFloat(averageError.toFixed(2)),
            maxError: parseFloat(Math.max.apply(null, errors).toFixed(2)),
            minError: parseFloat(Math.min.apply(null, errors).toFixed(2)),
            clicks: clicks.map(function(c) {
              return {
                x: parseFloat(c.x.toFixed(2)),
                y: parseFloat(c.y.toFixed(2)),
                error: parseFloat(c.error.toFixed(2))
              };
            }),
            bias: {
              x: parseFloat(avgX.toFixed(2)),
              y: parseFloat(avgY.toFixed(2))
            },
            unit: "px",
            recordedAt: new Date().toISOString()
          };
          if (typeof GAStorage !== "undefined") {
            GAStorage.writeSession({ motor: motor });
          }
          window.location.href = "motor_hub.html";
        });

        visualizeBtn.addEventListener("click", showVisualization);

        window.addEventListener("keydown", function(e) {
          if (e.key === "Escape") {
            closePopup();
          }
        });
      })();
    </script>
  </body>
</html>
