<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css">
    <title>정밀도 테스트 · 운동 측정</title>
    <style>
      :root {
        --bg: #020617;
        --accent: #7c3aed;
        --text-main: #e5e7eb;
        --text-muted: #b8c5d6;
        --ok: #4ade80;
        --danger: #f97373;
        --wait: #fbbf24;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-main);
        background: #020617;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      header {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
      }
      .back-btn {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(2, 6, 23, 0.9);
        color: var(--text-main);
        text-decoration: none;
        font-size: 12px;
      }
      .back-btn:hover { border-color: rgba(148, 163, 184, 0.9); }
      .test-container {
        width: 100%;
        max-width: 600px;
        margin-top: 60px;
      }
      .instruction {
        text-align: center;
        font-size: 16px;
        font-weight: 650;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        white-space: pre-line;
        font-weight: 600;
        margin-bottom: 16px;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-main);
        white-space: pre-line;
      }
      .precision-progress {
        text-align: center;
        margin-bottom: 12px;
      }
      .precision-progress .info-panel {
        display: inline-block;
        background: rgba(2, 6, 23, 0.9);
        padding: 10px 20px;
        border-radius: 999px;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-main);
      }
      #target-area {
        width: 100%;
        height: 500px;
        background: #1a1a1a;
        border-radius: 16px;
        position: relative;
        cursor: crosshair;
        overflow: hidden;
      }
      .grid-lines {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }
      .target {
        position: absolute;
        width: 40px;
        height: 40px;
        border: 3px solid var(--ok);
        border-radius: 50%;
        background: rgba(74, 222, 128, 0.1);
        transform: translate(-50%, -50%);
        z-index: 1;
        transition: left 0.15s, top 0.15s;
      }
      .target-center {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--ok);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        transition: left 0.15s, top 0.15s;
      }
      .click-dot {
        position: absolute;
        width: 6px;
        height: 6px;
        background: var(--danger);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 3;
      }
      .results-panel {
        margin-top: 30px;
        padding: 20px;
        background: rgba(2, 6, 23, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(51, 65, 85, 0.9);
        width: 100%;
        display: none;
      }
      .result-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        font-size: 14px;
      }
      .result-item:last-child {
        border-bottom: none;
        font-weight: 600;
        color: var(--ok);
        margin-top: 8px;
        padding-top: 12px;
        border-top: 2px solid rgba(51, 65, 85, 0.9);
      }
      .btn-primary {
        margin-top: 20px;
        padding: 10px 20px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(120deg, #4f46e5, #7c3aed, #22c55e);
        color: white;
        font-weight: 550;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
      }
      .btn-primary:hover { filter: brightness(1.1); }
      .btn-secondary {
        margin-top: 10px;
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(2, 6, 23, 0.8);
        color: var(--text-main);
        font-weight: 500;
        cursor: pointer;
        font-size: 13px;
        width: 100%;
      }
      .btn-secondary:hover {
        background: rgba(2, 6, 23, 0.95);
        border-color: rgba(148, 163, 184, 0.9);
      }
      .retry-btn {
        padding: 10px 20px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(30, 41, 59, 0.8);
        color: var(--text-main);
        font-weight: 550;
        cursor: pointer;
        font-size: 14px;
      }
      .retry-btn:hover { background: rgba(51, 65, 85, 0.9); border-color: rgba(148, 163, 184, 0.9); }
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .popup-content {
        background: #1a1a1a;
        border-radius: 20px;
        border: 2px solid #00ffcc;
        padding: 30px;
        max-width: 90vw;
        max-height: 90vh;
        overflow: auto;
        position: relative;
      }
      .popup-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        line-height: 1;
      }
      .popup-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      #visualization-canvas {
        display: block;
        margin: 20px auto;
        border: 1px solid rgba(148, 163, 184, 0.5);
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <header>
      <a href="motor_hub.html" class="back-btn">← 허브로</a>
      <div style="font-size: 12px; color: var(--text-muted);">정밀도 테스트</div>
    </header>

    <div class="test-container">
      <div class="instruction" id="instruction">바둑판 교차점에 나타나는 타겟의 정중앙을 클릭하세요.
(총 20회)</div>
      <div class="precision-progress" id="precision-progress">
        <div class="info-panel" id="info-panel">클릭: 0/20</div>
      </div>
      <div id="target-area">
        <div class="grid-lines"></div>
        <div class="target"></div>
        <div class="target-center"></div>
      </div>

      <div class="results-panel" id="results-panel">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">측정 결과</div>
        <div id="results-content"></div>
        <div style="display:flex; gap:12px; margin-top:20px; flex-wrap:wrap;">
        <button class="retry-btn" id="retry-btn">재시도</button>
        <button class="btn-primary" id="save-btn">결과 저장 & 허브로 이동</button>
        <button class="btn-secondary" id="visualize-btn">편향 시각화 보기</button>
      </div>
      </div>
    </div>

    <div class="popup-overlay" id="popup-overlay">
      <div class="popup-content">
        <button class="popup-close" id="popup-close-btn" type="button" aria-label="닫기">×</button>
        <h2 style="color:#00ffcc; margin-top:0;">클릭 편향 시각화</h2>
        <p style="font-size:0.9em; color:#9ca3af; margin-bottom:15px;">
          빨간 점은 실제 클릭 지점, 청록색 원은 각 교차점의 타겟 중심입니다. 점들의 분포를 통해 편향 방향을 확인할 수 있습니다.
        </p>
        <canvas id="visualization-canvas"></canvas>
      </div>
    </div>

    <script src="ga-storage.js"></script>
    <script>
      (function () {
        const targetArea = document.getElementById("target-area");
        const infoPanel = document.getElementById("info-panel");
        const instruction = document.getElementById("instruction");
        const resultsPanel = document.getElementById("results-panel");
        const resultsContent = document.getElementById("results-content");
        const saveBtn = document.getElementById("save-btn");
        const visualizeBtn = document.getElementById("visualize-btn");

        const TOTAL_CLICKS = 20;
        const COLS = 5;
        const ROWS = 4;
        const TARGET_RADIUS = 20;

        let clicks = [];
        let currentClick = 0;
        let gridPositions = [];
        let areaWidth = 600;
        let areaHeight = 500;

        function buildGrid() {
          const w = targetArea.offsetWidth || areaWidth;
          const h = targetArea.offsetHeight || areaHeight;
          areaWidth = w;
          areaHeight = h;
          const margin = Math.min(w, h) * 0.12;
          const gridW = w - 2 * margin;
          const gridH = h - 2 * margin;

          gridPositions = [];
          for (let row = 0; row < ROWS; row++) {
            for (let col = 0; col < COLS; col++) {
              const x = margin + (col / (COLS - 1)) * gridW;
              const y = margin + (row / (ROWS - 1)) * gridH;
              gridPositions.push({ x: x, y: y });
            }
          }

          const gridEl = targetArea.querySelector(".grid-lines");
          gridEl.innerHTML = "";
          const lineStyle = "position:absolute; background:rgba(148,163,184,0.25);";
          for (let i = 0; i < COLS; i++) {
            const div = document.createElement("div");
            const x = margin + (i / (COLS - 1)) * gridW;
            div.style.cssText = lineStyle + "left:" + x + "px;top:" + margin + "px;width:1px;height:" + gridH + "px;";
            gridEl.appendChild(div);
          }
          for (let i = 0; i < ROWS; i++) {
            const div = document.createElement("div");
            const y = margin + (i / (ROWS - 1)) * gridH;
            div.style.cssText = lineStyle + "left:" + margin + "px;top:" + y + "px;height:1px;width:" + gridW + "px;";
            gridEl.appendChild(div);
          }
        }

        function updateTargetPosition() {
          const pos = gridPositions[currentClick];
          if (!pos) return;
          const targetEl = targetArea.querySelector(".target");
          const centerEl = targetArea.querySelector(".target-center");
          targetEl.style.left = pos.x + "px";
          targetEl.style.top = pos.y + "px";
          centerEl.style.left = pos.x + "px";
          centerEl.style.top = pos.y + "px";
        }

        function calculateDistance(x1, y1, x2, y2) {
          return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        targetArea.addEventListener("click", function (e) {
          if (currentClick >= TOTAL_CLICKS) return;
          const pos = gridPositions[currentClick];
          if (!pos) return;

          const rect = targetArea.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const clickY = e.clientY - rect.top;
          const error = calculateDistance(clickX, clickY, pos.x, pos.y);

          clicks.push({
            targetX: pos.x,
            targetY: pos.y,
            x: clickX,
            y: clickY,
            error: error,
            timestamp: Date.now()
          });

          const dot = document.createElement("div");
          dot.className = "click-dot";
          dot.style.left = clickX + "px";
          dot.style.top = clickY + "px";
          targetArea.appendChild(dot);

          currentClick++;
          infoPanel.textContent = "클릭: " + currentClick + "/" + TOTAL_CLICKS;

          if (currentClick >= TOTAL_CLICKS) {
            showResults();
          } else {
            updateTargetPosition();
          }
        });

        function resetTest() {
          clicks = [];
          currentClick = 0;
          targetArea.querySelectorAll(".click-dot").forEach(function (el) { el.remove(); });
          instruction.style.display = "block";
          document.getElementById("precision-progress").style.display = "block";
          targetArea.style.display = "block";
          resultsPanel.style.display = "none";
          infoPanel.textContent = "클릭: 0/" + TOTAL_CLICKS;
          buildGrid();
          updateTargetPosition();
        }

        function showResults() {
          instruction.style.display = "none";
          document.getElementById("precision-progress").style.display = "none";
          targetArea.style.display = "none";
          resultsPanel.style.display = "block";
          
          const errors = clicks.map(function(c) { return c.error; });
          const averageError = errors.reduce(function(a, b) { return a + b; }, 0) / errors.length;
          const maxError = Math.max.apply(null, errors);
          const minError = Math.min.apply(null, errors);
          const totalTimeMs = clicks.length >= 2 ? clicks[clicks.length - 1].timestamp - clicks[0].timestamp : 0;
          const totalTimeSec = (totalTimeMs / 1000).toFixed(2);
          
          let html = '<div class="result-item"><span>평균 오차 거리</span><span>' + averageError.toFixed(2) + ' px</span></div>';
          html += '<div class="result-item"><span>최대 오차</span><span>' + maxError.toFixed(2) + ' px</span></div>';
          html += '<div class="result-item"><span>최소 오차</span><span>' + minError.toFixed(2) + ' px</span></div>';
          html += '<div class="result-item"><span>첫 클릭 ~ 마지막 클릭 소요 시간</span><span>' + totalTimeSec + ' 초</span></div>';
          html += '<div class="result-item"><span>총 클릭 수</span><span>' + clicks.length + ' 회</span></div>';
          resultsContent.innerHTML = html;
        }

        function showVisualization() {
          const visCanvas = document.getElementById("visualization-canvas");
          const visCtx = visCanvas.getContext("2d");
          const size = Math.min(600, window.innerWidth - 100);
          visCanvas.width = size;
          visCanvas.height = size;

          const areaW = areaWidth;
          const areaH = areaHeight;
          const scale = Math.min(size / areaW, size / areaH) * 0.9;
          const ox = (size - areaW * scale) / 2;
          const oy = (size - areaH * scale) / 2;

          function toCanvas(x, y) {
            return { x: ox + x * scale, y: oy + y * scale };
          }

          visCtx.fillStyle = "#1a1a1a";
          visCtx.fillRect(0, 0, size, size);

          const margin = Math.min(areaW, areaH) * 0.12;
          const gridW = areaW - 2 * margin;
          const gridH = areaH - 2 * margin;
          visCtx.strokeStyle = "rgba(148, 163, 184, 0.25)";
          visCtx.lineWidth = 1;
          for (let i = 0; i < COLS; i++) {
            const x = margin + (i / (COLS - 1)) * gridW;
            const p = toCanvas(x, margin);
            visCtx.beginPath();
            visCtx.moveTo(p.x, p.y);
            visCtx.lineTo(p.x, p.y + gridH * scale);
            visCtx.stroke();
          }
          for (let i = 0; i < ROWS; i++) {
            const y = margin + (i / (ROWS - 1)) * gridH;
            const p = toCanvas(margin, y);
            visCtx.beginPath();
            visCtx.moveTo(p.x, p.y);
            visCtx.lineTo(p.x + gridW * scale, p.y);
            visCtx.stroke();
          }

          clicks.forEach(function (c) {
            const tc = toCanvas(c.targetX, c.targetY);
            const pc = toCanvas(c.x, c.y);
            visCtx.strokeStyle = "#00ffcc";
            visCtx.lineWidth = 2;
            visCtx.beginPath();
            visCtx.arc(tc.x, tc.y, TARGET_RADIUS * scale, 0, Math.PI * 2);
            visCtx.stroke();
            visCtx.fillStyle = "#f97373";
            visCtx.beginPath();
            visCtx.arc(pc.x, pc.y, 3, 0, Math.PI * 2);
            visCtx.fill();
          });

          const avgOffsetX = clicks.reduce(function (s, c) { return s + (c.x - c.targetX); }, 0) / clicks.length;
          const avgOffsetY = clicks.reduce(function (s, c) { return s + (c.y - c.targetY); }, 0) / clicks.length;
          const avgTargetX = clicks.reduce(function (s, c) { return s + c.targetX; }, 0) / clicks.length;
          const avgTargetY = clicks.reduce(function (s, c) { return s + c.targetY; }, 0) / clicks.length;
          const centerX = ox + avgTargetX * scale;
          const centerY = oy + avgTargetY * scale;
          const biasX = centerX + avgOffsetX * scale;
          const biasY = centerY + avgOffsetY * scale;

          if (Math.abs(avgOffsetX) > 1 || Math.abs(avgOffsetY) > 1) {
            visCtx.strokeStyle = "#fbbf24";
            visCtx.lineWidth = 2;
            visCtx.setLineDash([5, 5]);
            visCtx.beginPath();
            visCtx.moveTo(centerX, centerY);
            visCtx.lineTo(biasX, biasY);
            visCtx.stroke();
            visCtx.setLineDash([]);
            visCtx.fillStyle = "#fbbf24";
            visCtx.beginPath();
            visCtx.arc(biasX, biasY, 4, 0, Math.PI * 2);
            visCtx.fill();
          }

          visCtx.fillStyle = "#fff";
          visCtx.font = "12px sans-serif";
          visCtx.textAlign = "left";
          visCtx.fillText("범례:", 20, size - 40);
          visCtx.fillStyle = "#00ffcc";
          visCtx.fillRect(20, size - 30, 12, 12);
          visCtx.fillStyle = "#fff";
          visCtx.fillText("타겟 중심", 38, size - 20);
          visCtx.fillStyle = "#f97373";
          visCtx.beginPath();
          visCtx.arc(20, size - 10, 3, 0, Math.PI * 2);
          visCtx.fill();
          visCtx.fillStyle = "#fff";
          visCtx.fillText("클릭 지점", 38, size - 6);
          if (Math.abs(avgOffsetX) > 1 || Math.abs(avgOffsetY) > 1) {
            visCtx.fillStyle = "#fbbf24";
            visCtx.beginPath();
            visCtx.arc(20, size + 10, 4, 0, Math.PI * 2);
            visCtx.fill();
            visCtx.fillStyle = "#fff";
            visCtx.fillText("평균 편향", 38, size + 16);
          }

          document.getElementById("popup-overlay").style.display = "flex";
        }

        function closePopup() {
          document.getElementById("popup-overlay").style.display = "none";
        }

        document.querySelector(".popup-close").addEventListener("click", closePopup);
        document.getElementById("retry-btn").addEventListener("click", resetTest);
        saveBtn.addEventListener("click", function () {
          if (clicks.length < TOTAL_CLICKS) return;

          const errors = clicks.map(function (c) { return c.error; });
          const averageError = errors.reduce(function (a, b) { return a + b; }, 0) / errors.length;
          const totalTimeMs = clicks.length >= 2 ? clicks[clicks.length - 1].timestamp - clicks[0].timestamp : 0;

          const avgX = clicks.reduce(function (s, c) { return s + (c.x - c.targetX); }, 0) / clicks.length;
          const avgY = clicks.reduce(function (s, c) { return s + (c.y - c.targetY); }, 0) / clicks.length;
          
          const session = (typeof GAStorage !== "undefined" && GAStorage.readSession()) || {};
          if (!session.user_data) session.user_data = {};
          const motor = session.user_data.motor_results || {};
          motor.precision = {
            averageError: parseFloat(averageError.toFixed(2)),
            maxError: parseFloat(Math.max.apply(null, errors).toFixed(2)),
            minError: parseFloat(Math.min.apply(null, errors).toFixed(2)),
            totalCompletionTimeMs: totalTimeMs,
            totalCompletionTimeSec: parseFloat((totalTimeMs / 1000).toFixed(2)),
            clicks: clicks.map(function (c) {
              return {
                targetX: parseFloat(c.targetX.toFixed(2)),
                targetY: parseFloat(c.targetY.toFixed(2)),
                x: parseFloat(c.x.toFixed(2)),
                y: parseFloat(c.y.toFixed(2)),
                error: parseFloat(c.error.toFixed(2))
              };
            }),
            bias: {
              x: parseFloat(avgX.toFixed(2)),
              y: parseFloat(avgY.toFixed(2))
            },
            unit: "px",
            recordedAt: new Date().toISOString()
          };
          if (typeof GAStorage !== "undefined") {
            GAStorage.writeSession({ motor: motor });
          }
          window.location.href = "motor_hub.html";
        });

        visualizeBtn.addEventListener("click", showVisualization);

        window.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closePopup();
          }
        });

        buildGrid();
        updateTargetPosition();
      })();
    </script>
  </body>
</html>
