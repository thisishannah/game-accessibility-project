<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>시각 측정 허브 · 게임 접근성</title>
    <link rel="stylesheet" href="style.css">
    <style>
      :root {
        --bg: #020617;
        --accent: #7c3aed;
        --accent-soft: rgba(124, 58, 237, 0.18);
        --accent-strong: rgba(124, 58, 237, 0.35);
        --border-subtle: rgba(148, 163, 184, 0.5);
        --text-main: #e5e7eb;
        --text-muted: #b8c5d6;
        --ok: #4ade80;
        --radius-lg: 20px;
        --radius-md: 12px;
        --radius-pill: 999px;
        --shadow-soft: 0 24px 60px rgba(15, 23, 42, 0.95);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-main);
        background: radial-gradient(circle at top, #111827 0, #020617 52%);
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: 32px 16px;
      }
      .shell {
        width: 100%;
        max-width: 1040px;
        background: radial-gradient(circle at top left, #020617 0, #020617 45%),
          radial-gradient(circle at bottom right, #020617 0, #020617 60%);
        border-radius: 26px;
        border: 1px solid rgba(148, 163, 184, 0.9);
        box-shadow: var(--shadow-soft);
        padding: 20px 22px 22px;
        position: relative;
        overflow: hidden;
      }
      .shell::before {
        content: "";
        position: absolute;
        inset: -35%;
        background:
          radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.24) 0, transparent 55%),
          radial-gradient(circle at 100% 0%, rgba(129, 140, 248, 0.26) 0, transparent 55%),
          radial-gradient(circle at 50% 120%, rgba(244, 114, 182, 0.18) 0, transparent 58%);
        opacity: 0.9;
        mix-blend-mode: soft-light;
        pointer-events: none;
      }
      .shell-inner { position: relative; z-index: 1; }
      header.header {
        grid-column: 1 / -1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 8px;
      }
      .brand { display: flex; align-items: center; gap: 10px; }
      .brand-logo {
        width: 32px;
        height: 32px;
        border-radius: 18px;
        background: conic-gradient(from 210deg, #7c3aed, #22d3ee, #f97316, #7c3aed);
        padding: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9), 0 10px 24px rgba(15, 23, 42, 0.9);
      }
      .brand-logo-inner {
        width: 100%;
        height: 100%;
        border-radius: 14px;
        background: radial-gradient(circle at 30% 15%, #e5e7eb, #e5e7eb 5%, #020617 70%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #020617;
        font-size: 15px;
        font-weight: 800;
      }
      .brand-text-main { display: flex; flex-direction: column; gap: 2px; }
      .brand-text-main span:first-child { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
      .brand-text-main span:last-child { font-size: 16px; font-weight: 650; }
      .header-meta { text-align: right; font-size: 14px; color: var(--text-secondary); }
      .header-meta strong { color: #e5e7eb; font-weight: 600; }
      @media (max-width: 900px) {
        header.header { flex-direction: column; align-items: flex-start; }
        .header-meta { text-align: left; }
      }
      .panel {
        background: radial-gradient(circle at top left, #020617 0, #020617 55%),
          radial-gradient(circle at bottom right, #020617 0, #020617 60%);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(51, 65, 85, 0.9);
        padding: 16px 18px 18px;
        margin-bottom: 14px;
      }
      .section-title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .section-title-pill {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--text-muted);
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 2px 9px;
        background: radial-gradient(circle at top, rgba(15, 23, 42, 0.92), #020617);
      }
      .section-subtitle {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 14px;
      }
      .test-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      @media (max-width: 640px) {
        .test-grid { grid-template-columns: minmax(0, 1fr); }
      }
      .test-card {
        border-radius: var(--radius-md);
        border: 1px solid rgba(51, 65, 85, 0.9);
        background: radial-gradient(circle at top, #020617 0, #020617 58%);
        padding: 12px 13px 13px;
        cursor: pointer;
        transition: transform 0.08s, border-color 0.15s, box-shadow 0.16s;
      }
      .test-card:hover {
        transform: translateY(-1px);
        border-color: rgba(148, 163, 184, 0.95);
        box-shadow: 0 14px 26px rgba(15, 23, 42, 0.95);
      }
      .test-card[data-complete="true"] {
        border-color: rgba(74, 222, 128, 0.6);
        background: radial-gradient(circle at top, rgba(74, 222, 128, 0.08), #020617 60%);
      }
      .test-card-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 8px;
      }
      .test-card-title {
        font-size: 13px;
        font-weight: 600;
      }
      .test-card-badge {
        font-size: 11px;
        font-variant-numeric: tabular-nums;
        border-radius: var(--radius-pill);
        padding: 2px 8px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: radial-gradient(circle at top, #020617, #020617 70%);
      }
      .test-card-badge[data-done="true"] {
        border-color: rgba(74, 222, 128, 0.8);
        color: var(--ok);
      }
      .test-card-desc {
        font-size: 11px;
        color: var(--text-muted);
        line-height: 1.4;
      }
      .btn-row {
        margin-top: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn-secondary {
        border-radius: var(--radius-pill);
        padding: 7px 13px 7px;
        border: 1px solid rgba(148, 163, 184, 0.8);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 500;
        color: rgba(209, 213, 219, 0.95);
        background: radial-gradient(circle at top, #020617, #020617 65%);
        transition: transform 0.08s, box-shadow 0.1s;
      }
      .btn-secondary:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.95);
      }
      .btn-icon {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: radial-gradient(circle at 25% 0%, #e5e7eb, #020617 65%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
      }
      .hint { font-size: 14px; font-weight: 500; color: var(--text-secondary); }
      .hint strong { color: #e5e7eb; font-weight: 600; }
      .progress-summary {
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px dashed rgba(51, 65, 85, 0.9);
        font-size: 12px;
      }
      .progress-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 6px;
      }
      .progress-label { color: var(--text-secondary); font-weight: 500; }
      .progress-value { font-variant-numeric: tabular-nums; font-weight: 550; }
      .summary-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(148, 163, 184, 0.8);
        padding: 3px 8px;
        background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), #020617);
        font-size: 11px;
        margin-top: 4px;
      }
      .right-body {
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.5;
      }
      .right-body ul { margin: 8px 0 0; padding-left: 18px; }
      .right-body li { margin-bottom: 4px; }
    </style>
  </head>
  <body>
    <main class="shell" aria-labelledby="vision-title">
      <div class="shell-inner">
        <header class="header">
          <div class="brand" aria-label="시각 측정 허브">
            <div class="brand-logo" aria-hidden="true">
              <div class="brand-logo-inner">GA</div>
            </div>
            <div class="brand-text-main">
              <span>게임 접근성 측정</span>
              <span id="vision-title">시각 측정 허브</span>
            </div>
          </div>
          <div class="header-meta" id="user-summary">세션 정보 로딩 중...</div>
        </header>

        <section class="panel" aria-label="시각 측정 테스트 선택">
          <div class="panel-inner">
            <div class="section-title">
              <span>시각 측정 테스트</span>
              <span class="section-title-pill">Vision Tests</span>
            </div>
            <p class="section-subtitle">
              아래 4개의 테스트를 모두 완료해야 시각 측정이 완료됩니다. 각 테스트는 이후 분석을 위한
              기준 데이터로 활용됩니다.
            </p>

            <div class="test-grid" id="test-grid">
              <article class="test-card" data-test="reaction-time" tabindex="0">
                <div class="test-card-head">
                  <div class="test-card-title">반응속도 테스트</div>
                  <span class="test-card-badge" data-progress="reaction-time" data-done="false">0/1</span>
                </div>
                <div class="test-card-desc">
                  화면이 초록색으로 변할 때 클릭. 총 4회 실시 후 각 기록과 평균값 저장.
                </div>
              </article>

              <article class="test-card" data-test="font" tabindex="0">
                <div class="test-card-head">
                  <div class="test-card-title">가독 폰트 크기</div>
                  <span class="test-card-badge" data-progress="font" data-done="false">0/1</span>
                </div>
                <div class="test-card-desc">
                  읽을 수 있는 최소 폰트 크기를 측정합니다.
                </div>
              </article>

              <article class="test-card" data-test="aim-trainer" tabindex="0">
                <div class="test-card-head">
                  <div class="test-card-title">에임 트레이너</div>
                  <span class="test-card-badge" data-progress="aim-trainer" data-done="false">0/1</span>
                </div>
                <div class="test-card-desc">
                  30개 타겟을 순차적으로 클릭. 소요 시간, 구간별 시간, 타겟 위치 데이터 저장.
                </div>
              </article>

              <article class="test-card" data-test="fov" tabindex="0">
                <div class="test-card-head">
                  <div class="test-card-title">9포인트 FOV</div>
                  <span class="test-card-badge" data-progress="fov" data-done="false">0/1</span>
                </div>
                <div class="test-card-desc">
                  화면 9개 지점에 대한 시야 한계치를 측정합니다.
                </div>
              </article>
            </div>

            <div class="btn-row divider">
              <button type="button" class="btn-secondary" id="back-to-hub">
                <span class="btn-icon" aria-hidden="true">◀</span>
                <span>허브로 돌아가기</span>
              </button>
              <p class="hint" id="final-hint">
                모든 테스트를 완료하면 허브에서 시각 측정이 완료로 표시됩니다.
              </p>
            </div>
          </div>
        </section>

        <aside class="panel" aria-label="진행 상황">
          <div class="panel-inner">
            <div class="section-title">
              <span>진행 상황</span>
              <span class="section-title-pill">Progress</span>
            </div>
            <div class="right-body">
              <p>시각 측정은 다음 4개 테스트로 구성됩니다.</p>
              <ul>
                <li><strong>반응속도</strong>: 기본 반응속도 측정 (4회 평균)</li>
                <li><strong>가독 폰트</strong>: 최소 가독 가능한 폰트 크기</li>
                <li><strong>에임 트레이너</strong>: 타겟 클릭 속도 및 위치 데이터</li>
                <li><strong>9포인트 FOV</strong>: 시야 한계치 측정</li>
              </ul>
            </div>
            <div class="progress-summary">
              <div class="progress-row">
                <span class="progress-label">반응속도</span>
                <span class="progress-value" id="progress-reaction">0/1</span>
              </div>
              <div class="progress-row">
                <span class="progress-label">가독 폰트</span>
                <span class="progress-value" id="progress-font">0/1</span>
              </div>
              <div class="progress-row">
                <span class="progress-label">에임 트레이너</span>
                <span class="progress-value" id="progress-aim">0/1</span>
              </div>
              <div class="progress-row">
                <span class="progress-label">9포인트 FOV</span>
                <span class="progress-value" id="progress-fov">0/1</span>
              </div>
              <div class="progress-row divider-solid">
                <span class="progress-label">전체</span>
                <span class="progress-value" id="progress-total">0/4</span>
              </div>
            </div>
            <div class="mt-md text-xs">
              <div>현재 세션</div>
              <div class="summary-pill">
                <span>ID</span>
                <span id="session-id-text">-</span>
                <span class="opacity-60 ml-xs">·</span>
                <span>장애</span>
                <span id="session-disability-text">-</span>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <script src="ga-storage.js"></script>
    <script>
      (function () {
        const userSummaryEl = document.getElementById("user-summary");
        const sessionIdText = document.getElementById("session-id-text");
        const sessionDisabilityText = document.getElementById("session-disability-text");
        const testGrid = document.getElementById("test-grid");
        const backToHubBtn = document.getElementById("back-to-hub");
        const finalHint = document.getElementById("final-hint");

        const TEST_CONFIG = {
          "reaction-time": { url: "reaction-time.html", label: "반응속도", total: 1 },
          "font": { url: "font.html", label: "가독 폰트", total: 1 },
          "aim-trainer": { url: "aim-trainer.html", label: "에임 트레이너", total: 1 },
          "fov": { url: "fov.html", label: "9포인트 FOV", total: 1 }
        };

        function readSession() {
          return (typeof GAStorage !== "undefined" && GAStorage.readSession()) || {};
        }

        function escapeHtml(str) {
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function updateUserSummary() {
          const session = readSession();
          const id = session.userId || session.id || "-";
          const disability = session.disabilityType || "-";
          sessionIdText.textContent = id || "-";
          sessionDisabilityText.textContent = disability || "-";
          if (!session.disabilityType) {
            userSummaryEl.innerHTML = "세션 정보가 없습니다. 메인 페이지에서 세션을 먼저 생성해 주세요.";
          } else {
            userSummaryEl.innerHTML = '세션 <strong>' + escapeHtml(id || "unnamed") + "</strong> · 장애 유형 <strong>" + escapeHtml(disability) + "</strong>";
          }
        }

        function checkTestCompletion(testKey) {
          const session = readSession();
          const vision = (session.user_data && session.user_data.vision_results) || {};
          if (testKey === "reaction-time") {
            return vision.reactionTime && vision.reactionTime.trials && vision.reactionTime.trials.length >= 4;
          } else if (testKey === "font") {
            return vision.fontReadability && vision.fontReadability.minFontSize;
          } else if (testKey === "aim-trainer") {
            return vision.aimTrainer && vision.aimTrainer.targets && vision.aimTrainer.targets.length >= 30;
          } else if (testKey === "fov") {
            return vision.fovResults && Array.isArray(vision.fovResults) && vision.fovResults.length > 0;
          }
          return false;
        }

        function updateProgress() {
          const session = readSession();
          const vision = (session.user_data && session.user_data.vision_results) || {};
          let totalComplete = 0;

          Object.keys(TEST_CONFIG).forEach(function (key) {
            const isComplete = checkTestCompletion(key);
            const badge = document.querySelector('[data-progress="' + key + '"]');
            const card = document.querySelector('[data-test="' + key + '"]');
            if (badge) {
              badge.textContent = (isComplete ? 1 : 0) + "/" + TEST_CONFIG[key].total;
              badge.dataset.done = isComplete ? "true" : "false";
            }
            if (card) {
              card.dataset.complete = isComplete ? "true" : "false";
            }
            if (isComplete) totalComplete++;
          });

          document.getElementById("progress-reaction").textContent = (checkTestCompletion("reaction-time") ? 1 : 0) + "/1";
          document.getElementById("progress-font").textContent = (checkTestCompletion("font") ? 1 : 0) + "/1";
          document.getElementById("progress-aim").textContent = (checkTestCompletion("aim-trainer") ? 1 : 0) + "/1";
          document.getElementById("progress-fov").textContent = (checkTestCompletion("fov") ? 1 : 0) + "/1";
          document.getElementById("progress-total").textContent = totalComplete + "/4";

          if (totalComplete >= 4) {
            finalHint.innerHTML = "<strong>모든 테스트가 완료되었습니다.</strong> 허브로 돌아가면 시각 측정이 완료로 표시됩니다.";
            if (typeof GAStorage !== "undefined") {
              GAStorage.writeProgress("visual", {
                label: "반응속도 + 폰트 + 에임 + FOV",
                current: 4,
                total: 4,
                completedAt: new Date().toISOString()
              });
            }
          } else {
            finalHint.textContent = "모든 테스트를 완료하면 허브에서 시각 측정이 완료로 표시됩니다.";
          }
        }

        testGrid.addEventListener("click", function (e) {
          const card = e.target.closest(".test-card");
          if (!card) return;
          const testKey = card.getAttribute("data-test");
          const config = TEST_CONFIG[testKey];
          if (config && config.url) {
            window.location.href = config.url;
          }
        });

        testGrid.addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") {
            const card = e.target.closest(".test-card");
            if (!card) return;
            e.preventDefault();
            card.click();
          }
        });

        backToHubBtn.addEventListener("click", function () {
          window.location.href = "hub.html";
        });

        updateUserSummary();
        updateProgress();
      })();
    </script>
  </body>
</html>
