<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css">
    <title>최대 홀드 시간 측정 · 운동 측정</title>
    <style>
      :root {
        --bg: #020617;
        --accent: #7c3aed;
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --ok: #4ade80;
        --danger: #f97373;
        --wait: #fbbf24;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-main);
        background: #020617;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      header {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
      }
      .back-btn {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(2, 6, 23, 0.9);
        color: var(--text-main);
        text-decoration: none;
        font-size: 12px;
      }
      .back-btn:hover { border-color: rgba(148, 163, 184, 0.9); }
      .test-container {
        width: 100%;
        max-width: 600px;
        margin-top: 60px;
      }
      .instruction {
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 30px;
        color: var(--text-main);
      }
      .hold-button {
        width: 100%;
        height: 200px;
        border-radius: 20px;
        border: 4px solid rgba(148, 163, 184, 0.6);
        background: #1a1a1a;
        color: var(--text-main);
        font-size: 24px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
      }
      .hold-button:active {
        background: var(--ok);
        border-color: var(--ok);
      }
      .hold-button.holding {
        background: var(--ok);
        border-color: var(--ok);
      }
      .gauge {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%;
        background: rgba(0, 255, 204, 0.3);
        transition: height 0.1s linear;
      }
      .time-display {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 48px;
        font-weight: 700;
        z-index: 2;
      }
      .results-panel {
        margin-top: 30px;
        padding: 20px;
        background: rgba(2, 6, 23, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(51, 65, 85, 0.9);
        width: 100%;
        display: none;
      }
      .result-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        font-size: 14px;
      }
      .result-item:last-child {
        border-bottom: none;
        font-weight: 600;
        color: var(--ok);
        margin-top: 8px;
        padding-top: 12px;
        border-top: 2px solid rgba(51, 65, 85, 0.9);
      }
      .btn-primary {
        margin-top: 20px;
        padding: 10px 20px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(120deg, #4f46e5, #7c3aed, #22c55e);
        color: white;
        font-weight: 550;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
      }
      .btn-primary:hover { filter: brightness(1.1); }
      .btn-primary:disabled { opacity: 0.5; cursor: default; }
      .retry-btn {
        margin-top: 15px;
        padding: 8px 16px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(2, 6, 23, 0.8);
        color: var(--text-main);
        font-weight: 500;
        cursor: pointer;
        font-size: 13px;
        width: 100%;
      }
      .retry-btn:hover {
        background: rgba(2, 6, 23, 0.95);
        border-color: rgba(148, 163, 184, 0.9);
      }
    </style>
  </head>
  <body>
    <header>
      <a href="motor_hub.html" class="back-btn">← 허브로</a>
      <div style="font-size: 12px; color: var(--text-muted);">최대 홀드 시간 측정</div>
    </header>

    <div class="test-container">
      <div class="instruction" id="instruction">버튼을 누르고 있는 동안 게이지가 차오릅니다.<br>손을 떼거나 입력이 끊기면 측정이 종료됩니다.</div>
      
      <button class="hold-button" id="hold-button">
        <div class="gauge" id="gauge"></div>
        <div class="time-display" id="time-display">0.00s</div>
      </button>

      <div class="results-panel" id="results-panel">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">측정 결과</div>
        <div id="results-content"></div>
        <button class="btn-primary" id="save-btn">결과 저장 & 허브로 이동</button>
        <button class="retry-btn" id="retry-btn">다시 측정하기</button>
      </div>
    </div>

    <script src="ga-storage.js"></script>
    <script>
      (function () {
        const holdButton = document.getElementById("hold-button");
        const gauge = document.getElementById("gauge");
        const timeDisplay = document.getElementById("time-display");
        const instruction = document.getElementById("instruction");
        const resultsPanel = document.getElementById("results-panel");
        const resultsContent = document.getElementById("results-content");
        const saveBtn = document.getElementById("save-btn");
        const retryBtn = document.getElementById("retry-btn");

        let isHolding = false;
        let startTime = 0;
        let currentDuration = 0;
        let gaugeInterval = null;
        let timeInterval = null;
        let maxDuration = 0;

        function startHold() {
          if (isHolding) return;
          isHolding = true;
          startTime = Date.now();
          holdButton.classList.add("holding");
          instruction.textContent = "버튼을 계속 누르고 있으세요...";
          
          gaugeInterval = setInterval(function () {
            currentDuration = (Date.now() - startTime) / 1000;
            const percentage = Math.min((currentDuration / 30) * 100, 100);
            gauge.style.height = percentage + "%";
            timeDisplay.textContent = currentDuration.toFixed(2) + "s";
            
            if (currentDuration > maxDuration) {
              maxDuration = currentDuration;
            }
          }, 10);
        }

        function stopHold() {
          if (!isHolding) return;
          isHolding = false;
          holdButton.classList.remove("holding");
          
          if (gaugeInterval) {
            clearInterval(gaugeInterval);
            gaugeInterval = null;
          }
          
          currentDuration = (Date.now() - startTime) / 1000;
          if (currentDuration > maxDuration) {
            maxDuration = currentDuration;
          }
          
          showResults();
        }

        function showResults() {
          instruction.style.display = "none";
          holdButton.style.display = "none";
          resultsPanel.style.display = "block";
          
          let html = '<div class="result-item"><span>측정된 시간</span><span>' + currentDuration.toFixed(2) + ' 초</span></div>';
          html += '<div class="result-item"><span>최대 홀드 시간</span><span>' + maxDuration.toFixed(2) + ' 초</span></div>';
          resultsContent.innerHTML = html;
        }

        function resetTest() {
          isHolding = false;
          startTime = 0;
          currentDuration = 0;
          maxDuration = 0;
          gauge.style.height = "0%";
          timeDisplay.textContent = "0.00s";
          holdButton.classList.remove("holding");
          instruction.style.display = "block";
          instruction.textContent = "버튼을 누르고 있는 동안 게이지가 차오릅니다.<br>손을 떼거나 입력이 끊기면 측정이 종료됩니다.";
          holdButton.style.display = "block";
          resultsPanel.style.display = "none";
          
          if (gaugeInterval) {
            clearInterval(gaugeInterval);
            gaugeInterval = null;
          }
          if (timeInterval) {
            clearInterval(timeInterval);
            timeInterval = null;
          }
        }

        holdButton.addEventListener("mousedown", startHold);
        holdButton.addEventListener("mouseup", stopHold);
        holdButton.addEventListener("mouseleave", stopHold);
        holdButton.addEventListener("touchstart", function(e) {
          e.preventDefault();
          startHold();
        });
        holdButton.addEventListener("touchend", function(e) {
          e.preventDefault();
          stopHold();
        });
        holdButton.addEventListener("touchcancel", function(e) {
          e.preventDefault();
          stopHold();
        });

        saveBtn.addEventListener("click", function () {
          const session = (typeof GAStorage !== "undefined" && GAStorage.readSession()) || {};
          if (!session.user_data) session.user_data = {};
          const motor = session.user_data.motor_results || {};
          motor.holdDuration = {
            duration: parseFloat(maxDuration.toFixed(2)),
            lastAttempt: parseFloat(currentDuration.toFixed(2)),
            unit: "s",
            recordedAt: new Date().toISOString()
          };
          if (typeof GAStorage !== "undefined") {
            GAStorage.writeSession({ motor: motor });
          }
          window.location.href = "motor_hub.html";
        });

        retryBtn.addEventListener("click", resetTest);
      })();
    </script>
  </body>
</html>
