<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì–¸ì–´ ëª…ë£Œë„ í…ŒìŠ¤íŠ¸ Â· ì²­ê°ì–¸ì–´ ì¸¡ì •</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root { --bg: #020617; --text-main: #e5e7eb; --text-muted: #b8c5d6; --ok: #4ade80; --danger: #f97373; }
    * { box-sizing: border-box; }
    body { margin: 0; min-height: 100vh; font-family: system-ui, sans-serif; color: var(--text-main);
      background: #020617; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    header { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
    .back-btn { padding: 6px 12px; border-radius: 999px; border: 1px solid rgba(148,163,184,0.6); background: rgba(2,6,23,0.9);
      color: var(--text-main); text-decoration: none; font-size: 12px; }
    .test-container { width: 100%; max-width: 600px; margin-top: 60px; }
    .intro-panel { padding: 24px; background: rgba(2,6,23,0.9); border-radius: 16px; border: 1px solid rgba(51,65,85,0.9); margin-bottom: 24px; }
    .intro-body { font-size: 14px; line-height: 1.7; color: var(--text-muted); margin-bottom: 20px; text-align: center; }
    .intro-body p { margin: 0 0 10px 0; }
    .instruction { text-align: center; font-size: 48px; font-weight: 600; margin-bottom: 20px; color: var(--text-main); min-height: 100px; display: flex; align-items: center; justify-content: center; }
    .word-item { margin-bottom: 24px; padding: 20px; background: rgba(15,23,42,0.6); border-radius: 12px; border: 1px solid rgba(51,65,85,0.9); }
    .play-btn { padding: 12px 24px; border-radius: 999px; border: none; background: linear-gradient(120deg,#4f46e5,#7c3aed); color: white; font-weight: 550; cursor: pointer; font-size: 14px; margin-bottom: 12px; }
    .play-btn:hover { filter: brightness(1.1); }
    .word-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(51,65,85,0.9); background: #020617; color: #e5e7eb; font-size: 14px; }
    .next-btn { margin-top: 12px; padding: 10px 20px; border-radius: 999px; border: none; background: #22c55e; color: white; font-weight: 550; cursor: pointer; width: 100%; }
    .results-panel { margin-top: 24px; padding: 20px; background: rgba(2,6,23,0.9); border-radius: 16px; border: 1px solid rgba(51,65,85,0.9); width: 100%; }
    .result-row { padding: 8px 0; border-bottom: 1px solid rgba(51,65,85,0.5); font-size: 14px; }
    .result-row.correct { color: var(--ok); }
    .result-row.wrong { color: var(--danger); }
    .btn-primary { margin-top: 20px; padding: 10px 20px; border-radius: 999px; border: none; background: linear-gradient(120deg,#4f46e5,#7c3aed,#22c55e); color: white; font-weight: 550; cursor: pointer; font-size: 14px; width: 100%; }
    .btn-primary:hover { filter: brightness(1.1); }
  </style>
</head>
<body>
  <header>
    <a href="hearing_hub.html" class="back-btn">â† í—ˆë¸Œë¡œ</a>
    <span style="font-size: 12px; color: var(--text-muted);">ì–¸ì–´ ëª…ë£Œë„ í…ŒìŠ¤íŠ¸</span>
  </header>

  <div class="test-container">
    <div class="intro-panel" id="intro-panel">
      <div class="intro-body">
        <p>5ê°œì˜ ë‹¨ì–´ê°€ ìˆœì„œëŒ€ë¡œ ì¬ìƒë©ë‹ˆë‹¤.</p>
        <p>ë“¤ë¦¬ëŠ” ë‹¨ì–´ë¥¼ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
        <p>4ê¸€ì ì´ìƒì˜ ë‹¨ì–´ë¡œ, ì¹´í…Œê³ ë¦¬ê°€ ëœë¤í•˜ê²Œ ì„ì—¬ ë‚˜ì˜µë‹ˆë‹¤.</p>
        <p>ì¤€ë¹„ë˜ë©´ <strong>ã€Œì‹œì‘í•˜ê¸°ã€</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</p>
      </div>
      <button class="btn-primary" id="ready-btn" style="width: auto; padding: 12px 30px; margin: 0 auto; display: block;">ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="test-area" style="display: none;">
      <div class="instruction" id="instruction">ë‹¨ì–´ 1/5</div>
      <div class="word-item">
        <button type="button" class="play-btn" id="play-btn">ğŸ”Š ë‹¨ì–´ ë“£ê¸°</button>
        <input type="text" class="word-input" id="word-input" placeholder="ë“¤ë¦° ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        <button type="button" class="next-btn" id="next-btn">ë‹¤ìŒ ë‹¨ì–´</button>
      </div>
    </div>

    <div id="results-panel" style="display: none;">
      <div class="instruction">í…ŒìŠ¤íŠ¸ ì™„ë£Œ</div>
      <div id="results-content"></div>
      <button class="btn-primary" id="save-btn">ê²°ê³¼ ì €ì¥ & í—ˆë¸Œë¡œ ì´ë™</button>
    </div>
  </div>

  <script src="ga-storage.js"></script>
  <script>
    (function () {
      const introPanel = document.getElementById("intro-panel");
      const readyBtn = document.getElementById("ready-btn");
      const testArea = document.getElementById("test-area");
      const instruction = document.getElementById("instruction");
      const playBtn = document.getElementById("play-btn");
      const wordInput = document.getElementById("word-input");
      const nextBtn = document.getElementById("next-btn");
      const resultsPanel = document.getElementById("results-panel");
      const resultsContent = document.getElementById("results-content");
      const saveBtn = document.getElementById("save-btn");

      const WORD_POOL = {
        ë™ë¬¼: ["ì½”ë¼ë¦¬", "ë°”ë‹¤í‘œë²”", "ë‚˜ë¹„", "ë‹¤ëŒì¥", "ì°¸ìƒˆ", "í† ë¼", "í­ê·„"],
        ìŒì‹: ["ìŠ¤íŠ¸ë¡œë² ë¦¬", "í† ë§ˆí† ", "ë°”ë‚˜ë‚˜", "ìˆ˜ë°•", "ì˜¤ë Œì§€", "íŒŒì¸ì• í”Œ"],
        ê¸°ìˆ : ["ì»´í“¨í„°", "í‚¤ë³´ë“œ", "ë§ˆì´í¬", "ìŠ¤í”¼ì»¤", "ëª¨ë‹ˆí„°", "í‚¤íŒ¨ë“œ"],
        ê²Œì„: ["ë ˆë²¨ì—…", "í€˜ìŠ¤íŠ¸", "ì¸ë²¤í† ë¦¬", "ì²´ë ¥ë°”", "ê²½í—˜ì¹˜"]
      };

      let words = [];
      let currentIndex = 0;
      let answers = [];
      let koVoice = null;

      function shuffle(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function buildWordList() {
        const categories = Object.keys(WORD_POOL);
        const shuffled = shuffle(categories);
        const selected = [];
        for (const cat of shuffled) {
          const pool = WORD_POOL[cat].filter(w => w.length >= 4);
          if (pool.length === 0) continue;
          const idx = Math.floor(Math.random() * pool.length);
          selected.push(pool[idx]);
          if (selected.length >= 5) break;
        }
        return selected.length >= 5 ? selected : selected.concat(["ì»´í“¨í„°", "í‚¤ë³´ë“œ", "ëª¨ë‹ˆí„°", "ìŠ¤í”¼ì»¤", "ë§ˆì´í¬"].slice(0, 5 - selected.length));
      }

      function initVoice() {
        const voices = speechSynthesis.getVoices();
        const ko = voices.find(v => v.lang.startsWith("ko") && v.localService);
        if (ko) return ko;
        return voices.find(v => v.lang.startsWith("ko")) || voices[0];
      }

      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = function () { koVoice = initVoice(); };
      }
      koVoice = initVoice();

      function speakWord(word) {
        if (!("speechSynthesis" in window)) {
          alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± í•©ì„± ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return;
        }
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(word);
        u.lang = "ko-KR";
        u.rate = 0.9;
        u.pitch = 1.0;
        u.volume = 1.0;
        if (koVoice) u.voice = koVoice;
        speechSynthesis.speak(u);
      }

      function startTest() {
        words = buildWordList();
        currentIndex = 0;
        answers = [];
        introPanel.style.display = "none";
        testArea.style.display = "block";
        resultsPanel.style.display = "none";
        showWord();
      }

      function showWord() {
        if (currentIndex >= words.length) {
          showResults();
          return;
        }
        const w = words[currentIndex];
        instruction.textContent = "ë‹¨ì–´ " + (currentIndex + 1) + "/" + words.length;
        wordInput.value = "";
        wordInput.focus();
        playBtn.onclick = function () { speakWord(w); };
      }

      nextBtn.addEventListener("click", function () {
        const w = words[currentIndex];
        const userAnswer = wordInput.value.trim();
        answers.push({ word: w, userAnswer: userAnswer, correct: userAnswer === w });
        currentIndex++;
        showWord();
      });

      wordInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") nextBtn.click();
      });

      function showResults() {
        testArea.style.display = "none";
        resultsPanel.style.display = "block";
        const correctCount = answers.filter(a => a.correct).length;
        const percent = (correctCount / words.length) * 100;
        let html = "<div style=\"font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--ok);\">ìˆ˜ìŒ ëª…ë£Œë„: " + correctCount + "/" + words.length + " (" + percent.toFixed(0) + "%)</div>";
        answers.forEach(function (a, i) {
          html += "<div class=\"result-row " + (a.correct ? "correct" : "wrong") + "\">" + (i + 1) + ". ì •ë‹µ: \"" + a.word + "\" / ì…ë ¥: \"" + (a.userAnswer || "(ì…ë ¥ ì—†ìŒ)") + "\"</div>";
        });
        resultsContent.innerHTML = html;
      }

      saveBtn.addEventListener("click", function () {
        const correctCount = answers.filter(a => a.correct).length;
        const percent = (correctCount / words.length) * 100;
        const session = (typeof GAStorage !== "undefined" && GAStorage.readSession()) || {};
        if (!session.user_data) session.user_data = {};
        const hearing = session.user_data.hearing_results || {};
        hearing.speechClarityTest = {
          words: words,
          answers: answers,
          correctCount: correctCount,
          totalWords: words.length,
          clarityPercent: percent
        };
        hearing.speechClarityPercent = percent;
        hearing.recordedAt = new Date().toISOString();
        if (typeof GAStorage !== "undefined") {
          GAStorage.writeSession({ hearing: hearing });
          let done = 0;
          if (hearing.source && hearing.overallDb != null) done++;
          if (hearing.speechClarityTest) done++;
          if (hearing.articulationTest && hearing.articulationTest.matchRate != null) done++;
          GAStorage.writeProgress("audio", { label: "ì²­ê°ì–¸ì–´ ì¸¡ì •", current: done, total: 3, completedAt: new Date().toISOString() });
        }
        window.location.href = "hearing_hub.html";
      });

      readyBtn.addEventListener("click", startTest);
    })();
  </script>
</body>
</html>
