<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css">
    <title>연타 입력 테스트 · 운동 측정</title>
    <style>
      :root {
        --bg: #020617;
        --accent: #7c3aed;
        --text-main: #e5e7eb;
        --text-muted: #b8c5d6;
        --ok: #4ade80;
        --danger: #f97373;
        --wait: #94a3b8;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-main);
        background: var(--bg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      header {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
      }
      .back-btn {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(2, 6, 23, 0.9);
        color: var(--text-main);
        text-decoration: none;
        font-size: 12px;
      }
      .back-btn:hover { border-color: rgba(148, 163, 184, 0.9); }
      .test-container {
        width: 100%;
        max-width: 600px;
        margin-top: 60px;
      }
      .instruction {
        text-align: center;
        font-size: 16px;
        font-weight: 650;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        line-height: 1.6;
        margin-bottom: 20px;
        color: var(--text-main);
        min-height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        white-space: pre-line;
      }
      .instruction p {
        margin: 0 0 0.6em 0;
        line-height: 1.6;
      }
      .instruction p:last-child { margin-bottom: 0; }
      .instruction .hint {
        font-size: 16px;
        color: var(--text-muted);
        margin-top: 12px;
      }
      .device-visual {
        width: 100%;
        min-height: 200px;
        border-radius: 20px;
        border: 4px solid var(--wait);
        background: #1a1a1a;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0;
        position: relative;
        transition: border-color 0.2s, background 0.2s;
      }
      .device-visual.active {
        border-color: var(--ok);
        background: rgba(74, 222, 128, 0.08);
      }
      .device-visual .count-zone {
        width: 100%;
        min-height: 72px;
        display: none;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        padding: 12px 0;
      }
      .device-visual .count-zone.visible {
        display: flex;
      }
      .device-visual .count-overlay {
        font-size: 48px;
        font-weight: 700;
        line-height: 1;
        transition: color 0.2s;
      }
      .device-visual .count-overlay.countdown {
        color: #fbbf24;
      }
      .device-visual .count-overlay.countup {
        color: #4ade80;
      }
      .device-visual .device-area {
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
        min-height: 120px;
        padding: 16px 0;
      }
      .space-key {
        width: 280px;
        height: 80px;
        border-radius: 12px;
        border: 4px solid var(--wait);
        background: #2a2a2a;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 600;
        color: var(--text-muted);
        transition: all 0.2s;
      }
      .device-visual.active .space-key {
        border-color: var(--ok);
        background: rgba(74, 222, 128, 0.15);
        color: var(--ok);
      }
      .mouse-visual {
        width: 120px;
        height: 180px;
        border-radius: 60px 60px 20px 20px;
        border: 4px solid var(--wait);
        background: #2a2a2a;
        position: relative;
        transition: all 0.2s;
        flex-shrink: 0;
      }
      .mouse-visual .left-btn {
        position: absolute;
        top: 24px;
        left: 12px;
        width: 48px;
        height: 55px;
        border-radius: 8px;
        border: 3px solid var(--wait);
        background: #1a1a1a;
        transition: all 0.2s;
      }
      .device-visual.active .mouse-visual {
        border-color: var(--ok);
        background: rgba(74, 222, 128, 0.08);
      }
      .device-visual.active .mouse-visual .left-btn {
        border-color: var(--ok);
        background: rgba(74, 222, 128, 0.25);
      }
      .phase-label {
        text-align: center;
        font-size: 42px;
        min-height: 56px;
        color: var(--text-muted);
        margin-top: 16px;
      }
      .results-panel {
        margin-top: 30px;
        padding: 20px;
        background: rgba(2, 6, 23, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(51, 65, 85, 0.9);
        width: 100%;
        display: none;
      }
      .result-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        font-size: 14px;
      }
      .result-item:last-child { border-bottom: none; }
      .result-item.section { font-weight: 600; color: var(--ok); margin-top: 12px; }
      .btn-primary {
        margin-top: 20px;
        padding: 10px 20px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(120deg, #4f46e5, #7c3aed, #22c55e);
        color: white;
        font-weight: 550;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
      }
      .btn-primary:hover { filter: brightness(1.1); }
      .btn-row-results { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
      .btn-row-results .btn-primary { margin-top: 0; flex: 1; min-width: 120px; }
      .retry-btn {
        padding: 10px 20px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(30, 41, 59, 0.8);
        color: var(--text-main);
        font-weight: 550;
        cursor: pointer;
        font-size: 14px;
      }
      .retry-btn:hover { background: rgba(51, 65, 85, 0.9); }
    </style>
  </head>
  <body>
    <header>
      <a href="motor_hub.html" class="back-btn">← 허브로</a>
      <div style="font-size: 12px; color: var(--text-muted);">연타 입력 테스트</div>
    </header>

    <div class="test-container">
      <div class="instruction" id="instruction"></div>
      <div class="phase-label" id="phase-label"></div>

      <div class="device-visual" id="device-visual">
        <div class="count-zone" id="count-zone">
          <div class="count-overlay" id="count-overlay"></div>
        </div>
        <div class="device-area">
          <div class="space-key" id="space-key">Space</div>
          <div class="mouse-visual" id="mouse-visual" style="display: none;"><div class="left-btn"></div></div>
        </div>
      </div>

      <div class="results-panel" id="results-panel">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">측정 결과</div>
        <div id="results-content"></div>
        <div class="btn-row-results">
          <button class="retry-btn" id="retry-btn">다시 측정하기</button>
          <button class="btn-primary" id="save-btn">결과 저장 & 허브로 이동</button>
        </div>
      </div>
    </div>

    <script src="ga-storage.js"></script>
    <script>
      (function () {
        const instruction = document.getElementById("instruction");
        const phaseLabel = document.getElementById("phase-label");
        const deviceVisual = document.getElementById("device-visual");
        const countZone = document.getElementById("count-zone");
        const countOverlay = document.getElementById("count-overlay");
        const spaceKey = document.getElementById("space-key");
        const mouseVisual = document.getElementById("mouse-visual");
        const resultsPanel = document.getElementById("results-panel");
        const resultsContent = document.getElementById("results-content");
        const saveBtn = document.getElementById("save-btn");
        const retryBtn = document.getElementById("retry-btn");

        const TEST_DURATION = 5;
        const COUNTDOWN_SEC = 3;

        let phase = "keyboard"; // keyboard | mouse | done
        let state = "idle"; // idle | countdown | recording | done
        let startTime = 0;
        let keyboardInputs = [];
        let mouseInputs = [];
        let countdownTimer = null;
        let recordingTimer = null;

        const KEYBOARD_DIRECTION = "<p>스페이스 버튼이 초록색으로 바뀌면 5초 동안 연속해서 키보드의 스페이스 버튼을 눌러주세요.</p><p>할 수 있는 한 가장 빠른 속도로 연속해서 눌러주세요.</p>";
        const MOUSE_DIRECTION = "<p>좌측 마우스 버튼이 초록색으로 바뀌면 5초 동안 연속해서 마우스의 좌측 버튼을 눌러주세요.</p><p>할 수 있는 한 가장 빠른 속도로 연속해서 눌러주세요.</p>";

        function showKeyboardPhase() {
          phase = "keyboard";
          state = "idle";
          instruction.innerHTML = KEYBOARD_DIRECTION + '<p class="hint">화면을 클릭하면 3초 후 시작됩니다</p>';
          phaseLabel.textContent = "1/2 · 키보드 (스페이스)";
          spaceKey.style.display = "flex";
          mouseVisual.style.display = "none";
          deviceVisual.classList.remove("active");
          countOverlay.textContent = "";
          countOverlay.style.display = "none";
          countZone.classList.remove("visible");
        }

        function showMousePhase() {
          phase = "mouse";
          state = "idle";
          instruction.innerHTML = MOUSE_DIRECTION + '<p class="hint">화면을 클릭하면 3초 후 시작됩니다</p>';
          phaseLabel.textContent = "2/2 · 마우스 (좌클릭)";
          spaceKey.style.display = "none";
          mouseVisual.style.display = "block";
          deviceVisual.classList.remove("active");
          countOverlay.textContent = "";
          countOverlay.style.display = "none";
          countZone.classList.remove("visible");
        }

        function startCountdown() {
          if (state !== "idle") return;
          state = "countdown";
          const hint = instruction.querySelector(".hint");
          if (hint) hint.textContent = "";
          countZone.classList.add("visible");
          countOverlay.style.display = "block";
          countOverlay.className = "count-overlay countdown";
          let n = COUNTDOWN_SEC;
          countOverlay.textContent = n;

          countdownTimer = setInterval(function () {
            n--;
            if (n > 0) {
              countOverlay.textContent = n;
            } else {
              clearInterval(countdownTimer);
              deviceVisual.classList.add("active");
              startRecording();
            }
          }, 1000);
        }

        function startRecording() {
          state = "recording";
          startTime = Date.now();
          if (phase === "keyboard") keyboardInputs = [];
          else mouseInputs = [];

          countOverlay.className = "count-overlay countup";
          let sec = 1;
          countOverlay.textContent = sec;

          recordingTimer = setInterval(function () {
            const elapsed = (Date.now() - startTime) / 1000;
            if (elapsed >= TEST_DURATION) {
              endRecording();
              return;
            }
            const nextSec = Math.floor(elapsed) + 1;
            if (nextSec !== sec) {
              sec = nextSec;
              countOverlay.textContent = sec;
            }
          }, 50);
        }

        function endRecording() {
          clearInterval(recordingTimer);
          state = "done";
          deviceVisual.classList.remove("active");
          countOverlay.style.display = "none";
          countZone.classList.remove("visible");

          if (phase === "keyboard") {
            showMousePhase();
          } else {
            showFinalResults();
          }
        }

        function handleKeyboardInput() {
          if (state !== "recording" || phase !== "keyboard") return;
          const elapsed = (Date.now() - startTime) / 1000;
          if (elapsed >= TEST_DURATION) return;
          keyboardInputs.push({ elapsed: elapsed });
        }

        function handleMouseInput() {
          if (state !== "recording" || phase !== "mouse") return;
          const elapsed = (Date.now() - startTime) / 1000;
          if (elapsed >= TEST_DURATION) return;
          mouseInputs.push({ elapsed: elapsed });
        }

        function showFinalResults() {
          phase = "done";
          instruction.style.display = "none";
          phaseLabel.style.display = "none";
          deviceVisual.style.display = "none";
          resultsPanel.style.display = "block";

          const kbCount = keyboardInputs.length;
          const msCount = mouseInputs.length;
          const kbRate = TEST_DURATION > 0 ? kbCount / TEST_DURATION : 0;
          const msRate = TEST_DURATION > 0 ? msCount / TEST_DURATION : 0;

          let html = '<div class="result-item section">키보드 (스페이스)</div>';
          html += '<div class="result-item"><span>총 입력 수</span><span>' + kbCount + ' 회</span></div>';
          html += '<div class="result-item"><span>초당 입력수</span><span>' + Math.round(kbRate) + ' 입력/초</span></div>';
          html += '<div class="result-item section">마우스 (좌클릭)</div>';
          html += '<div class="result-item"><span>총 클릭 수</span><span>' + msCount + ' 회</span></div>';
          html += '<div class="result-item"><span>초당 클릭수</span><span>' + Math.round(msRate) + ' 클릭/초</span></div>';
          resultsContent.innerHTML = html;
        }

        function resetTest() {
          clearInterval(countdownTimer);
          clearInterval(recordingTimer);
          state = "idle";
          phase = "keyboard";
          instruction.style.display = "block";
          phaseLabel.style.display = "block";
          deviceVisual.style.display = "flex";
          resultsPanel.style.display = "none";
          showKeyboardPhase();
        }

        deviceVisual.addEventListener("click", function (e) {
          if (state === "idle") startCountdown();
        });

        document.addEventListener("keydown", function (e) {
          if (e.code === "Space") {
            e.preventDefault();
            if (state === "idle") startCountdown();
            else if (state === "recording" && phase === "keyboard") handleKeyboardInput();
          }
        });

        document.addEventListener("mousedown", function (e) {
          if (e.button === 0 && state === "recording" && phase === "mouse") {
            e.preventDefault();
            handleMouseInput();
          }
        });

        saveBtn.addEventListener("click", function () {
          const kbCount = keyboardInputs.length;
          const msCount = mouseInputs.length;
          const kbRate = TEST_DURATION > 0 ? kbCount / TEST_DURATION : 0;
          const msRate = TEST_DURATION > 0 ? msCount / TEST_DURATION : 0;

          const session = (typeof GAStorage !== "undefined" && GAStorage.readSession()) || {};
          if (!session.user_data) session.user_data = {};
          const motor = session.user_data.motor_results || {};
          motor.burstSpeed = {
            keyboard: {
              totalInputs: kbCount,
              inputsPerSecond: Math.round(kbRate),
              inputs: keyboardInputs.map(function (i) { return { elapsed: parseFloat(i.elapsed.toFixed(3)) }; })
            },
            mouse: {
              totalInputs: msCount,
              inputsPerSecond: Math.round(msRate),
              inputs: mouseInputs.map(function (i) { return { elapsed: parseFloat(i.elapsed.toFixed(3)) }; })
            },
            duration: TEST_DURATION,
            unit: "inputs/second",
            recordedAt: new Date().toISOString()
          };
          if (typeof GAStorage !== "undefined") {
            GAStorage.writeSession({ motor: motor });
          }
          window.location.href = "motor_hub.html";
        });

        retryBtn.addEventListener("click", resetTest);

        showKeyboardPhase();
      })();
    </script>
  </body>
</html>
