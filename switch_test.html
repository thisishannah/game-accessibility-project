<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css">
    <title>ì¡°ì‘ ìì› ì œì•½ - ë””ë°”ì´ìŠ¤ ì „í™˜ ì†ë„ Â· ìš´ë™ ì¸¡ì •</title>
    <style>
      :root {
        --bg: #020617;
        --accent: #7c3aed;
        --text-main: #e5e7eb;
        --text-muted: #b8c5d6;
        --ok: #4ade80;
        --danger: #f97373;
        --wait: #fbbf24;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: var(--text-main);
        background: var(--bg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      header {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
      }
      .back-btn {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(2, 6, 23, 0.9);
        color: var(--text-main);
        text-decoration: none;
        font-size: 12px;
        cursor: pointer;
      }
      .back-btn:hover { border-color: rgba(148, 163, 184, 0.9); }
      .test-container { width: 100%; max-width: 600px; margin-top: 60px; }

      .instruction-screen {
        background: rgba(15, 23, 42, 0.95);
        border: 2px solid rgba(148, 163, 184, 0.5);
        border-radius: 20px;
        padding: 32px;
        text-align: center;
      }
      .instruction-screen h2 {
        font-size: 20px;
        margin: 0 0 24px;
        color: var(--text-main);
      }
      .instruction-screen p {
        font-size: 15px;
        line-height: 1.7;
        color: var(--text-muted);
        margin: 0 0 24px;
      }
      .step-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        margin: 20px 0;
        padding: 20px;
        background: rgba(0,0,0,0.3);
        border-radius: 12px;
      }
      .device-icon {
        width: 64px;
        height: 64px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(148, 163, 184, 0.15);
        border: 2px solid rgba(148, 163, 184, 0.5);
        border-radius: 12px;
      }
      .device-icon.mouse { font-size: 28px; }
      .device-icon.keyboard { font-size: 24px; }
      .step-text {
        text-align: left;
        font-size: 16px;
        color: var(--text-main);
      }
      .step-text strong { color: var(--ok); }
      .start-hint {
        margin-top: 28px;
        padding: 16px;
        background: rgba(74, 222, 128, 0.1);
        border: 1px solid var(--ok);
        border-radius: 12px;
        font-size: 15px;
        color: var(--ok);
        cursor: pointer;
      }
      .start-hint:hover { background: rgba(74, 222, 128, 0.2); }

      .test-area {
        width: 100%;
        max-width: 600px;
        min-height: 400px;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        position: relative;
        margin-top: 20px;
        background: #1a1a1a;
        border: 2px solid rgba(148, 163, 184, 0.4);
      }
      .test-area.waiting { cursor: pointer; }
      .test-area.prompt-key { cursor: default; }
      .test-area.done { cursor: default; }
      .phase-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 24px;
      }
      .phase-box {
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        background: rgba(148, 163, 184, 0.1);
        border: 2px solid rgba(148, 163, 184, 0.4);
        color: var(--text-muted);
      }
      .phase-box.active {
        background: rgba(251, 191, 36, 0.15);
        border-color: var(--wait);
        color: var(--wait);
      }
      .phase-box.done {
        background: rgba(74, 222, 128, 0.15);
        border-color: var(--ok);
        color: var(--ok);
      }
      .prompt-msg {
        font-size: 18px;
        color: var(--text-muted);
        margin-bottom: 16px;
      }
      .key-display-large {
        font-size: 72px;
        font-weight: 700;
        padding: 24px 48px;
        background: rgba(0,0,0,0.5);
        border: 4px solid var(--wait);
        border-radius: 16px;
        color: var(--wait);
        font-family: monospace;
        margin: 16px 0;
      }
      .feedback-msg {
        font-size: 20px;
        font-weight: 600;
        margin-top: 16px;
        min-height: 28px;
      }
      .feedback-msg.hit { color: var(--ok); }
      .feedback-msg.miss { color: var(--danger); }
      .feedback-msg.dup { color: var(--wait); }
      .progress-text {
        font-size: 14px;
        color: var(--text-muted);
        margin-top: 16px;
      }
      .results-panel {
        margin-top: 30px;
        padding: 20px;
        background: rgba(2, 6, 23, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(51, 65, 85, 0.9);
        width: 100%;
        max-width: 600px;
      }
      .result-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        font-size: 14px;
      }
      .result-item:last-child { border-bottom: none; }
      .result-item.section { font-weight: 600; color: var(--ok); margin-top: 12px; }
      .btn-primary {
        margin-top: 20px;
        padding: 10px 20px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(120deg, #4f46e5, #7c3aed, #22c55e);
        color: white;
        font-weight: 550;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-primary:hover { filter: brightness(1.1); }
      .btn-row-results { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
      .btn-row-results .btn-primary, .btn-row-results .retry-btn { flex: 1; min-width: 120px; margin-top: 0; }
      .retry-btn {
        padding: 10px 20px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(30, 41, 59, 0.8);
        color: var(--text-main);
        font-weight: 550;
        cursor: pointer;
        font-size: 14px;
      }
      .retry-btn:hover { background: rgba(51, 65, 85, 0.9); }
    </style>
  </head>
  <body>
    <header>
      <a href="motor_hub.html" class="back-btn">â† í—ˆë¸Œë¡œ</a>
      <div style="font-size: 12px; color: var(--text-muted);">ë””ë°”ì´ìŠ¤ ì „í™˜ ì†ë„</div>
    </header>

    <div class="test-container">
      <div class="instruction-screen" id="instruction-screen">
        <h2>ë””ë°”ì´ìŠ¤ ì „í™˜ ì†ë„ í…ŒìŠ¤íŠ¸</h2>
        <p>ë§ˆìš°ìŠ¤ í´ë¦­ í›„ í‚¤ë³´ë“œ ì…ë ¥ê¹Œì§€ì˜ ë°˜ì‘ ì†ë„ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.<br>ê²Œì„ì—ì„œ ìì£¼ ì‚¬ìš©í•˜ëŠ” í‚¤ì™€ ìˆ«ìíŒ¨ë“œÂ·ìš°ì¸¡ í‚¤ë¥¼ ë²ˆê°ˆì•„ ì¸¡ì •í•©ë‹ˆë‹¤.</p>
        <div class="step-row">
          <div class="device-icon mouse" aria-hidden="true">ğŸ–±</div>
          <div class="step-text"><strong>1ë‹¨ê³„</strong> ì•„ë˜ ì˜ì—­ì„ <strong>ë§ˆìš°ìŠ¤ë¡œ í´ë¦­</strong>í•˜ì„¸ìš”.</div>
        </div>
        <div class="step-row">
          <div class="device-icon keyboard" aria-hidden="true">âŒ¨</div>
          <div class="step-text"><strong>2ë‹¨ê³„</strong> í™”ë©´ ì¤‘ì•™ì— í‘œì‹œëœ <strong>í‚¤ë¥¼ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ</strong> ëˆ„ë¥´ì„¸ìš”.<br>ì˜ëª»ëœ í‚¤ë¥¼ ëˆ„ë¥´ë©´ Miss, ê°™ì€ í‚¤ë¥¼ ì—¬ëŸ¬ ë²ˆ ëˆ„ë¥´ë©´ ì¤‘ë³µìœ¼ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤.</div>
        </div>
        <div class="start-hint" id="start-btn">â–¼ ì—¬ê¸°ë¥¼ ë§ˆìš°ìŠ¤ë¡œ í´ë¦­í•˜ë©´ ì‹œì‘í•©ë‹ˆë‹¤</div>
      </div>

      <div class="test-area" id="test-area">
        <div class="phase-indicator">
          <span class="phase-box" id="phase-mouse">ğŸ–± í´ë¦­</span>
          <span class="phase-box" id="phase-key">âŒ¨ í‚¤ ì…ë ¥</span>
        </div>
        <div class="prompt-msg" id="prompt-msg">ì´ ì˜ì—­ì„ ë§ˆìš°ìŠ¤ë¡œ í´ë¦­í•˜ì„¸ìš”</div>
        <div class="key-display-large" id="key-display" style="display: none;"></div>
        <div class="feedback-msg" id="feedback-msg"></div>
        <div class="progress-text" id="progress-text">0/8 íšŒì°¨</div>
      </div>

      <div class="results-panel" id="results-panel" style="display: none;">
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">ì¸¡ì • ê²°ê³¼</div>
        <div id="results-list"></div>
        <div class="btn-row-results">
          <button class="retry-btn" id="retry-btn">ì¬ì‹œë„</button>
          <button class="btn-primary" id="save-btn">ê²°ê³¼ ì €ì¥ & í—ˆë¸Œë¡œ ì´ë™</button>
        </div>
      </div>
    </div>

    <script src="ga-storage.js"></script>
    <script>
      (function () {
        const instructionScreen = document.getElementById("instruction-screen");
        const startBtn = document.getElementById("start-btn");
        const testArea = document.getElementById("test-area");
        const phaseMouse = document.getElementById("phase-mouse");
        const phaseKey = document.getElementById("phase-key");
        const promptMsg = document.getElementById("prompt-msg");
        const keyDisplay = document.getElementById("key-display");
        const feedbackMsg = document.getElementById("feedback-msg");
        const progressText = document.getElementById("progress-text");
        const resultsPanel = document.getElementById("results-panel");
        const resultsList = document.getElementById("results-list");
        const saveBtn = document.getElementById("save-btn");
        const retryBtn = document.getElementById("retry-btn");

        const GAME_KEYS = ["W", "A", "S", "D", "E", "R", "Q", "F", "1", "2", "3", "4"];
        const RIGHT_KEYS = ["Space", "Enter", "Numpad1", "Numpad2", "Numpad5", "NumpadEnter"];
        const TOTAL_TRIALS = 8;

        const KEY_TO_CODE = {
          "W": ["KeyW", "w"], "A": ["KeyA", "a"], "S": ["KeyS", "s"], "D": ["KeyD", "d"],
          "E": ["KeyE", "e"], "R": ["KeyR", "r"], "Q": ["KeyQ", "q"], "F": ["KeyF", "f"],
          "1": ["Digit1", "1"], "2": ["Digit2", "2"], "3": ["Digit3", "3"], "4": ["Digit4", "4"],
          "Space": ["Space", " "],
          "Enter": ["Enter"],
          "Numpad1": ["Numpad1"], "Numpad2": ["Numpad2"], "Numpad5": ["Numpad5"],
          "NumpadEnter": ["NumpadEnter"]
        };

        const DISPLAY_NAMES = {
          "Numpad1": "1", "Numpad2": "2", "Numpad5": "5",
          "NumpadEnter": "Num Enter"
        };

        function shuffle(arr) {
          const a = arr.slice();
          for (let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
          }
          return a;
        }

        function buildTrialSequence() {
          const game = shuffle(GAME_KEYS).slice(0, 4);
          const right = shuffle(RIGHT_KEYS).slice(0, 4);
          return shuffle(game.concat(right));
        }

        function keyMatches(keyName, e) {
          const codes = KEY_TO_CODE[keyName];
          if (!codes) return false;
          return codes.some(function(c) {
            return e.code === c || e.key === c || (c.length === 1 && e.key.toLowerCase() === c.toLowerCase());
          });
        }

        function getPressedKeyName(e) {
          const map = { Space: "Space", Enter: "Enter", NumpadEnter: "NumpadEnter",
            Numpad1: "Numpad1", Numpad2: "Numpad2", Numpad5: "Numpad5" };
          if (map[e.code]) return map[e.code];
          if (e.code && e.code.startsWith("Key")) return e.key ? e.key.toUpperCase() : e.code.slice(-1).toUpperCase();
          if (e.code && e.code.startsWith("Digit")) return e.key || e.code.slice(-1);
          return e.key || e.code || "?";
        }

        let trialKeys = [];
        let trials = [];
        let currentTrial = 0;
        let clickTime = 0;
        let keyHandler = null;
        let hasRecordedThisTrial = false;

        function removeKeyHandler() {
          if (keyHandler) {
            document.removeEventListener("keydown", keyHandler);
            keyHandler = null;
          }
        }

        function showInstruction() {
          instructionScreen.style.display = "block";
          testArea.style.display = "none";
          resultsPanel.style.display = "none";
        }

        function startTest() {
          instructionScreen.style.display = "none";
          testArea.style.display = "flex";
          trialKeys = buildTrialSequence();
          trials = [];
          currentTrial = 0;
          startTrial();
        }

        function startTrial() {
          if (currentTrial >= TOTAL_TRIALS) {
            showResults();
            return;
          }
          hasRecordedThisTrial = false;
          phaseMouse.classList.add("active");
          phaseMouse.classList.remove("done");
          phaseKey.classList.remove("active", "done");
          keyDisplay.style.display = "none";
          feedbackMsg.textContent = "";
          feedbackMsg.className = "feedback-msg";
          promptMsg.textContent = "ì´ ì˜ì—­ì„ ë§ˆìš°ìŠ¤ë¡œ í´ë¦­í•˜ì„¸ìš”";
          progressText.textContent = (currentTrial + 1) + "/" + TOTAL_TRIALS + " íšŒì°¨";

          testArea.onclick = function (e) {
            if (e.button !== 0) return;
            clickTime = Date.now();
            testArea.onclick = null;
            phaseMouse.classList.remove("active");
            phaseMouse.classList.add("done");
            phaseKey.classList.add("active");

            const targetKey = trialKeys[currentTrial];
            const displayName = DISPLAY_NAMES[targetKey] || targetKey;
            promptMsg.textContent = "ì§€ê¸ˆ ì•„ë˜ í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”!";
            keyDisplay.textContent = displayName;
            keyDisplay.style.display = "block";

            keyHandler = function (ev) {
              ev.preventDefault();
              const pressed = getPressedKeyName(ev);
              const isCorrect = keyMatches(targetKey, ev);

              if (isCorrect) {
                if (hasRecordedThisTrial) {
                  feedbackMsg.textContent = "ì¤‘ë³µ ì…ë ¥";
                  feedbackMsg.className = "feedback-msg dup";
                  trials[trials.length - 1].duplicateInput = true;
                  setTimeout(function() {
                    removeKeyHandler();
                    phaseKey.classList.remove("active");
                    phaseKey.classList.add("done");
                    currentTrial++;
                    keyDisplay.style.display = "none";
                    startTrial();
                  }, 800);
                } else {
                  hasRecordedThisTrial = true;
                  const latency = Date.now() - clickTime;
                  const keyGroup = RIGHT_KEYS.includes(targetKey) ? "right" : "game";
                  trials.push({
                    round: currentTrial + 1,
                    expectedKey: targetKey,
                    latency: latency,
                    status: "Hit",
                    keyGroup: keyGroup,
                    duplicateInput: false
                  });
                  feedbackMsg.textContent = latency + " ms";
                  feedbackMsg.className = "feedback-msg hit";
                  removeKeyHandler();
                  phaseKey.classList.remove("active");
                  phaseKey.classList.add("done");
                  currentTrial++;
                  keyDisplay.style.display = "none";
                  setTimeout(startTrial, 1000);
                }
              } else {
                const keyGroup = RIGHT_KEYS.includes(targetKey) ? "right" : "game";
                trials.push({
                  round: currentTrial + 1,
                  expectedKey: targetKey,
                  pressedKey: pressed,
                  status: "Miss",
                  keyGroup: keyGroup
                });
                feedbackMsg.textContent = "Miss (ì…ë ¥: " + pressed + ")";
                feedbackMsg.className = "feedback-msg miss";
                removeKeyHandler();
                phaseKey.classList.remove("active");
                phaseKey.classList.add("done");
                currentTrial++;
                keyDisplay.style.display = "none";
                setTimeout(startTrial, 1500);
              }
            };
            document.addEventListener("keydown", keyHandler);
          };
        }

        function resetTest() {
          removeKeyHandler();
          testArea.style.display = "flex";
          resultsPanel.style.display = "none";
          showInstruction();
        }

        function showResults() {
          testArea.style.display = "none";
          resultsPanel.style.display = "block";

          const hitTrials = trials.filter(function(t) { return t.status === "Hit"; });
          const missTrials = trials.filter(function(t) { return t.status === "Miss"; });
          const dupCount = trials.filter(function(t) { return t.duplicateInput; }).length;
          const latencies = hitTrials.map(function(t) { return t.latency; });
          const avg = latencies.length ? Math.round(latencies.reduce(function(a,b){return a+b;},0) / latencies.length) : 0;
          const min = latencies.length ? Math.min.apply(null, latencies) : 0;
          const max = latencies.length ? Math.max.apply(null, latencies) : 0;

          let html = '<div class="result-item"><span>ì„±ê³µ (Hit)</span><span>' + hitTrials.length + ' íšŒ</span></div>';
          html += '<div class="result-item"><span>ì‹¤íŒ¨ (Miss)</span><span>' + missTrials.length + ' íšŒ</span></div>';
          if (dupCount > 0) html += '<div class="result-item"><span>ì¤‘ë³µ ì…ë ¥ ë°œìƒ</span><span>' + dupCount + ' íšŒ</span></div>';
          html += '<div class="result-item section">ì§€ì—° ì‹œê°„ (Hitë§Œ)</div>';
          html += '<div class="result-item"><span>í‰ê· </span><span>' + avg + ' ms</span></div>';
          html += '<div class="result-item"><span>ìµœì†Œ</span><span>' + min + ' ms</span></div>';
          html += '<div class="result-item"><span>ìµœëŒ€</span><span>' + max + ' ms</span></div>';
          html += '<div class="result-item section">íšŒì°¨ë³„ ìƒì„¸</div>';
          trials.forEach(function(t) {
            let desc = "ë§ˆìš°ìŠ¤â†’" + (DISPLAY_NAMES[t.expectedKey] || t.expectedKey);
            if (t.status === "Hit") desc += ": " + t.latency + "ms" + (t.duplicateInput ? " (ì¤‘ë³µ)" : "");
            else desc += ": Miss (ì…ë ¥: " + (t.pressedKey || "-") + ")";
            html += '<div class="result-item" style="font-size: 12px;"><span>' + t.round + 'íšŒì°¨</span><span>' + desc + '</span></div>';
          });
          resultsList.innerHTML = html;
        }

        document.getElementById("start-btn").addEventListener("click", startTest);

        retryBtn.addEventListener("click", resetTest);
        saveBtn.addEventListener("click", function () {
          const hitTrials = trials.filter(function(t) { return t.status === "Hit"; });
          const latencies = hitTrials.map(function(t) { return t.latency; });
          const avg = latencies.length ? Math.round(latencies.reduce(function(a,b){return a+b;},0) / latencies.length) : null;

          const trialDetails = trials.map(function(t) {
            const r = {
              round: t.round,
              expectedKey: t.expectedKey,
              status: t.status,
              keyGroup: t.keyGroup
            };
            if (t.status === "Hit") r.latencyMs = t.latency;
            if (t.status === "Miss") r.pressedKey = t.pressedKey;
            if (t.duplicateInput) r.duplicateInput = true;
            return r;
          });

          const session = (typeof GAStorage !== "undefined" && GAStorage.readSession()) || {};
          if (!session.user_data) session.user_data = {};
          const motor = session.user_data.motor_results || {};
          motor.switching_latency = {
            trials: trialDetails,
            hitCount: hitTrials.length,
            missCount: trials.filter(function(t) { return t.status === "Miss"; }).length,
            duplicateCount: trials.filter(function(t) { return t.duplicateInput; }).length,
            average: avg,
            min: latencies.length ? Math.min.apply(null, latencies) : null,
            max: latencies.length ? Math.max.apply(null, latencies) : null,
            unit: "ms",
            recordedAt: new Date().toISOString()
          };
          if (typeof GAStorage !== "undefined") {
            GAStorage.writeSession({ motor: motor });
          }
          window.location.href = "motor_hub.html";
        });

        showInstruction();
      })();
    </script>
  </body>
</html>
